<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>SIREP 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--accent:#0039BA;--text:#111;--muted:#6b7280;--line:#e5e7eb;--bg:#fff;--hdr-a:#0B5FA8;--hdr-b:#108CBC;--hdr-c:#49C3B6;--prog-a:#ef7d00;--prog-b:#F7A600}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--hdr-a),var(--hdr-b),var(--hdr-c));color:#fff}
    .top{display:flex;align-items:center;justify-content:center;padding:12px 16px;position:relative}
    .top h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.5px}
    .top .icons{position:absolute;right:12px;display:flex;gap:12px}
    .icon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,.12);cursor:pointer}
    main{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tab{padding:12px 16px;cursor:pointer;font-weight:600;border-bottom:2px solid transparent}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .content{padding:16px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .progress-row{display:flex;flex-direction:column;align-items:flex-start;gap:6px;margin-top:8px;width:100%}
    button{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);padding:9px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    select{border:1px solid var(--line);background:#fff;color:var(--text);padding:8px 12px;border-radius:10px;font-weight:600;min-width:160px}
    select:focus{outline:2px solid rgba(16,140,188,.25);outline-offset:1px}
    #btnIniciar,#btnContinuar{padding:9px 14px;font-size:14px;border-radius:10px}
    button.primary{border:0;color:#fff;background:#108CBC;box-shadow:none;transition:transform .15s ease,background-color .15s ease}
    button.primary:hover:not(:disabled){background:#0b749f;transform:translateY(-1px)}
    #btnContinuar:not(.primary){background:#f3f4f6;color:var(--muted);border-color:#d1d5db}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .progress{height:10px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;overflow:hidden;width:100%;min-width:220px;flex:1 1 auto}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--prog-a),var(--prog-b));position:relative;transition:width .2s ease}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--line)}
    th{text-align:left;font-size:12px;color:#4b5563;font-weight:700;letter-spacing:.3px}
    .right{text-align:right}
    th.filterable{position:relative}
    .th-filter{display:inline-flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
    .th-filter.no-toggle{cursor:default}
    .th-filter-label{display:flex;flex-direction:column;line-height:1}
    .filter-toggle{border:0;background:transparent;width:22px;height:22px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;padding:0;transition:background-color .2s ease}
    .th-filter:hover .filter-toggle,.filter-toggle:focus-visible{background:rgba(16,140,188,.12);outline:none}
    .filter-toggle svg{width:12px;height:12px;stroke:#4b5563;stroke-width:2;fill:none;transition:transform .2s ease}
    .filter-toggle.open svg{transform:rotate(180deg)}
    .filter-menu{position:fixed;top:auto;left:auto;min-width:160px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 14px 32px rgba(15,23,42,.18);padding:6px;display:none;z-index:200}
    .filter-menu.open{display:block}
    .filter-option{display:flex;width:100%;padding:8px 10px;border:0;background:transparent;font-weight:600;color:var(--text);border-radius:8px;cursor:pointer;text-align:left}
    .filter-option:hover,.filter-option:focus-visible{background:rgba(16,140,188,.12);outline:none}
    .filter-option.active{color:var(--accent);background:rgba(16,140,188,.08)}
    .grid{display:grid;grid-template-columns:minmax(0,1fr) clamp(260px,24vw,360px);gap:16px;align-items:stretch} @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .grid>aside{display:flex;flex-direction:column;min-height:0}
    .log{border:1px solid var(--line);border-radius:10px;padding:10px;overflow:auto;background:#fafafa;flex:1 1 auto;min-height:280px}
    .log p{margin:0 0 6px}
    .log .log-active{font-weight:600}
    .log .log-history{color:var(--muted);font-size:12px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .page-footer{margin:48px auto 24px;text-align:center;font-size:12px;color:var(--muted);line-height:1.6}
    .page-footer p{margin:0}
    .state{font-weight:700}
    /* sub-abas dentro da seção */
    .subtabs{display:flex;gap:14px;align-items:center;margin:12px 0 6px}
    .subtab{font-weight:700;opacity:.6;cursor:pointer}
    .subtab.active{color:var(--accent);opacity:1}
    .badge{display:inline-block;min-width:18px;padding:0 6px;border-radius:999px;background:#fef2f2;color:#b91c1c;font-weight:800;font-size:11px;border:1px solid #fecaca;vertical-align:middle;margin-left:6px}
    /* link copyable */
    .copy{color:#0b5fa8;cursor:pointer;text-decoration:underline;position:relative;display:inline-block}
    .copy.copied{color:#16a34a;text-decoration:none}
    .copy.copied::after{content:"item copiado";position:absolute;left:50%;top:-32px;transform:translateX(-50%);background:rgba(17,17,17,.92);color:#fff;font-size:11px;font-weight:600;padding:4px 8px;border-radius:6px;white-space:nowrap;box-shadow:0 4px 10px rgba(0,0,0,.18);pointer-events:none;animation:copy-tooltip .9s ease;z-index:20}
    .copy.copied::before{content:"";position:absolute;left:50%;top:-10px;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(17,17,17,.92);pointer-events:none;animation:copy-tooltip-arrow .9s ease;z-index:19}
    @keyframes copy-tooltip{0%{opacity:0;transform:translate(-50%,-4px)}20%{opacity:1;transform:translate(-50%,-10px)}80%{opacity:1;transform:translate(-50%,-12px)}100%{opacity:0;transform:translate(-50%,-14px)}}
    @keyframes copy-tooltip-arrow{0%{opacity:0;transform:translate(-50%,2px)}20%{opacity:1;transform:translate(-50%,0)}80%{opacity:1;transform:translate(-50%,-1px)}100%{opacity:0;transform:translate(-50%,-2px)}}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.55);backdrop-filter:blur(2px);z-index:50;padding:16px}
    .modal-backdrop.active{display:flex}
    .modal-card{background:#f8fafc;border-radius:18px;max-width:360px;width:100%;box-shadow:0 20px 48px rgba(15,23,42,.28);border:1px solid rgba(15,23,42,.14);overflow:hidden;padding:0;text-align:left}
    .modal-card[role="document"]{outline:none}
    .modal-titlebar{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,#0b5fa8,#108cbc);color:#fff;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.35)}
    .modal-titlebar h3{margin:0;font-size:16px;font-weight:800;letter-spacing:.3px}
    .modal-title-icon{width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,.18);display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;color:#fff}
    .modal-title-icon svg{width:18px;height:18px;stroke:#fff;stroke-width:2.2}
    .modal-close{margin-left:auto;border:0;background:rgba(255,255,255,.16);color:#fff;width:28px;height:28px;border-radius:6px;font-size:16px;font-weight:700;line-height:1;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:background-color .15s ease,transform .15s ease}
    .modal-close:hover,.modal-close:focus-visible{background:rgba(255,255,255,.28);outline:none;transform:translateY(-1px)}
    .modal-body{padding:24px 24px 18px;display:flex;gap:16px;align-items:flex-start;background:#fff}
    .modal-illustration{width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,rgba(15,95,168,.12),rgba(16,140,188,.25));display:inline-flex;align-items:center;justify-content:center;color:var(--accent);flex-shrink:0;border:1px solid rgba(16,140,188,.2);box-shadow:inset 0 0 0 1px rgba(255,255,255,.4)}
    .modal-illustration svg{width:26px;height:26px;stroke:currentColor;stroke-width:2.2}
    .modal-copy{flex:1 1 auto;color:var(--text)}
    .modal-message{margin:0 0 8px;font-size:17px;font-weight:800;color:#0f172a}
    .modal-detail{margin:0;color:#475569;font-size:13px;line-height:1.6}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;padding:18px 24px 22px;background:linear-gradient(180deg,#f8fafc 0%,#eef2f7 100%);border-top:1px solid rgba(15,23,42,.08)}
    .modal-card button{min-width:96px}
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>SIREP 2.0</h1>
    <div class="icons">
      <div class="icon" title="Configurações" aria-label="Configurações">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V22a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.04 2.4l.06.06a1.65 1.65 0 0 0 1.82.33H8a1.65 1.65 0 0 0 1-1.51V2a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V8c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73H22a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </div>
      <div class="icon" title="Conta" aria-label="Conta">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="gestao">Gestão da Base</div>
      <div class="tab" data-tab="tratamento">Tratamento</div>
    </div>
    <div class="content">
      <section id="tab-gestao">
        <div class="grid">
          <div>
            <div class="row" style="margin-bottom:10px;">
              <div class="controls">
                <button id="btnIniciar" class="primary">Iniciar</button>
                <button id="btnPausar">Pausar</button>
                <button id="btnContinuar" disabled>Continuar</button>
              </div>
            </div>
            <div class="progress-row">
              <div class="progress" title="Progresso total"><div id="barTotal" style="width:0%"></div></div>
              <span id="lblTotal" class="muted">0% concluído</span>
            </div>

            <div class="muted" id="ultimaAtualizacao">Última atualização: —</div>

            <div class="subtabs">
              <span class="subtab active" id="subtabPlanos">Planos capturados</span>
              <span class="subtab" id="subtabOcorr">Ocorrências <span class="badge" id="badgeOcorr">0</span></span>
            </div>

            <!-- Tabela Planos -->
            <div id="wrapPlanos">
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th scope="col">CARTEIRA</th>
                    <th scope="col">GIFUG</th>
                    <th class="filterable" scope="col">
                      <div class="th-filter no-toggle">
                        <div class="th-filter-label">
                          <span>SITUAÇÃO</span>
                        </div>
                      </div>
                    </th>
                    <th scope="col">TIPO</th>
                    <th class="right" scope="col">DIAS EM ATRASO</th>
                    <th class="right" scope="col">SALDO</th>
                    <th scope="col">DT SITUAÇÃO</th>
                  </tr></thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
              <div class="footer">
                <div class="muted" id="footerInfo">nada a exibir por aqui.</div>
                <div><button id="btnAnterior">Anterior</button><span class="muted" id="lblPaginaTotal" style="margin:0 6px">pág. 1 de 1</span><button id="btnProximo">Próximo</button></div>
              </div>
            </div>

            <!-- Tabela Ocorrências -->
            <div id="wrapOcorr" style="display:none">
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th>CARTEIRA</th>
                    <th class="filterable" scope="col">
                      <div class="th-filter" id="filtroOcorrTrigger">
                        <div class="th-filter-label">
                          <span>SITUAÇÃO</span>
                        </div>
                        <button type="button" class="filter-toggle" id="filtroOcorrToggle" aria-haspopup="true" aria-expanded="false" aria-controls="filtroOcorrMenu" aria-label="Filtrar ocorrências por situação" title="Filtrar ocorrências por situação">
                          <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true"><path d="M3 4.5 6 7.5l3-3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                      </div>
                    </th>
                    <th>CNPJ</th><th>TIPO</th><th class="right">SALDO</th><th>DT SITUAÇÃO</th>
                  </tr></thead>
                  <tbody id="tbodyOcc"></tbody>
                </table>
              </div>
              <div class="filter-menu" id="filtroOcorrMenu" role="menu" aria-labelledby="filtroOcorrTrigger">
                <button type="button" class="filter-option active" data-value="TODAS" role="menuitemradio" aria-checked="true">Todas</button>
                <button type="button" class="filter-option" data-value="SIT ESPECIAL" role="menuitemradio" aria-checked="false">Sit especial</button>
                <button type="button" class="filter-option" data-value="LIQUIDADO" role="menuitemradio" aria-checked="false">Liquidado</button>
                <button type="button" class="filter-option" data-value="RESCINDIDO" role="menuitemradio" aria-checked="false">Rescindido</button>
                <button type="button" class="filter-option" data-value="GRDE Emitida" role="menuitemradio" aria-checked="false">GRDE emitida</button>
              </div>
              <div class="footer">
                <div class="muted" id="footerInfoOcc">nada a exibir por aqui.</div>
                <div><button id="btnAnteriorOcc">Anterior</button><span class="muted" id="lblPaginaTotalOcc" style="margin:0 6px">pág. 1 de 1</span><button id="btnProximoOcc">Próximo</button></div>
              </div>
            </div>
          </div>

          <aside>
            <h4 style="margin:6px 0 8px">Status: <span class="state" id="estadoTexto">Ocioso</span></h4>
            <div class="log" id="log"></div>
          </aside>
        </div>
      </section>

      <section id="tab-tratamento" style="display:none"><p class="muted">Em breve.</p></section>
    </div>
  </div>
</main>

<div class="modal-backdrop" id="modalConcluido" role="dialog" aria-modal="true" aria-labelledby="modalConcluidoTitulo" aria-hidden="true">
  <div class="modal-card" role="document" tabindex="-1">
    <div class="modal-titlebar">
      <span class="modal-title-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none"><path d="m6 12 4 4 8-8" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </span>
      <h3 id="modalConcluidoTitulo">Processamento concluído</h3>
      <button type="button" id="btnModalClose" class="modal-close" aria-label="Fechar aviso">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-illustration" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 3c4.97 0 9 4.03 9 9s-4.03 9-9 9-9-4.03-9-9 4.03-9 9-9Z" stroke="currentColor" stroke-width="1.6"/><path d="m9.5 12 1.95 1.95 4.05-4.05" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="modal-copy">
        <p class="modal-message">Captura finalizada com sucesso.</p>
        <p class="modal-detail">Os planos foram processados sem pendências e esta janela segue um visual clássico para destacar o fim da captura.</p>
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" id="btnModalOk" class="primary">Ok</button>
    </div>
  </div>
</div>

<footer class="page-footer" aria-label="Informações de desenvolvimento">
  <p>Desenvolvido por:</p>
  <p>CEFGD/RJ – Recuperação de Débitos do FGTS Perante o Empregador</p>
  <p>CAIXA™ - 2025</p>
</footer>

<script>
function $(selector){ return document.querySelector(selector); }
const fmtMoney=n=>n==null?"":Number(n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
function formatDateBR(value){
  if(!value) return "";
  if(value instanceof Date&&!Number.isNaN(value.getTime())){
    const day=String(value.getDate()).padStart(2,"0");
    const month=String(value.getMonth()+1).padStart(2,"0");
    const year=value.getFullYear();
    return `${day}/${month}/${year}`;
  }
  const str=String(value).trim();
  if(!str) return "";
  const isoMatch=str.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s]|$)/);
  if(isoMatch){
    return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
  }
  const timestamp=Date.parse(str);
  if(!Number.isNaN(timestamp)){
    const date=new Date(timestamp);
    if(!Number.isNaN(date.getTime())){
      const day=String(date.getDate()).padStart(2,"0");
      const month=String(date.getMonth()+1).padStart(2,"0");
      const year=date.getFullYear();
      return `${day}/${month}/${year}`;
    }
  }
  return str;
}
const TIMEZONE="America/Sao_Paulo";
function formatDateTime(value,options){
  if(!value)return"";
  const date=new Date(value);
  if(Number.isNaN(date.getTime()))return"";
  const opts={timeZone:TIMEZONE,...(options||{})};
  return date.toLocaleString("pt-BR",opts);
}
const el={
  btnIniciar:$("#btnIniciar"), btnPausar:$("#btnPausar"), btnContinuar:$("#btnContinuar"),
  barTotal:$("#barTotal"), lblTotal:$("#lblTotal"), ultima:$("#ultimaAtualizacao"),
  tbody:$("#tbody"), btnProximo:$("#btnProximo"), btnAnterior:$("#btnAnterior"),
  lblPaginaTotal:$("#lblPaginaTotal"), footerInfo:$("#footerInfo"),
  tbodyOcc:$("#tbodyOcc"), btnProximoOcc:$("#btnProximoOcc"), btnAnteriorOcc:$("#btnAnteriorOcc"),
  lblPaginaTotalOcc:$("#lblPaginaTotalOcc"), footerInfoOcc:$("#footerInfoOcc"),
  filtroOcorrToggle:$("#filtroOcorrToggle"), filtroOcorrMenu:$("#filtroOcorrMenu"),
  filtroOcorrTrigger:$("#filtroOcorrTrigger"),
  log:$("#log"), estadoTexto:$("#estadoTexto"),
  subtabPlanos:$("#subtabPlanos"), subtabOcorr:$("#subtabOcorr"), badgeOcorr:$("#badgeOcorr"),
  modalConcluido:$("#modalConcluido"), btnModalOk:$("#btnModalOk"), btnModalClose:$("#btnModalClose")
};
const mainColumn=document.querySelector(".grid > div");
const asideColumn=document.querySelector(".grid > aside");
const logElement=el.log;
const requestFrame=(typeof window!=="undefined"&&typeof window.requestAnimationFrame==="function")
  ? window.requestAnimationFrame.bind(window)
  : (fn)=>setTimeout(fn,16);
const MIN_LOG_HEIGHT=280;
let logHeightFrame=null;
function resetLogSizing(){
  if(logElement){
    logElement.style.removeProperty("maxHeight");
    logElement.style.removeProperty("minHeight");
    logElement.style.removeProperty("height");
  }
  if(asideColumn){
    asideColumn.style.removeProperty("height");
  }
  if(mainColumn){
    mainColumn.style.removeProperty("minHeight");
    mainColumn.style.removeProperty("maxHeight");
    mainColumn.style.removeProperty("overflow");
  }
}
function syncLogHeight(){
  if(!mainColumn||!asideColumn||!logElement){
    resetLogSizing();
    return;
  }
  // clear previous inline sizing so measurements reflect the current layout
  logElement.style.removeProperty("maxHeight");
  logElement.style.removeProperty("minHeight");
  logElement.style.removeProperty("height");
  asideColumn.style.removeProperty("height");
  mainColumn.style.removeProperty("minHeight");
  mainColumn.style.removeProperty("maxHeight");
  mainColumn.style.removeProperty("overflow");
  const isStacked=typeof window!=="undefined"&&typeof window.matchMedia==="function"&&window.matchMedia("(max-width: 980px)").matches;
  if(isStacked){
    resetLogSizing();
    return;
  }
  const mainRect=mainColumn.getBoundingClientRect();
  if(mainRect.height<=0){
    resetLogSizing();
    return;
  }
  const asideRect=asideColumn.getBoundingClientRect();
  const asideStyle=getComputedStyle(asideColumn);
  const logStyle=getComputedStyle(logElement);
  const logRect=logElement.getBoundingClientRect();
  const relativeTop=logRect.top-asideRect.top;
  const logMarginBottom=parseFloat(logStyle.marginBottom)||0;
  const bottomSpacing=logMarginBottom+(parseFloat(asideStyle.paddingBottom)||0)+(parseFloat(asideStyle.borderBottomWidth)||0);
  const available=Math.max(0,mainRect.height-relativeTop-bottomSpacing);
  if(available<=0){
    resetLogSizing();
    return;
  }
  const minHeight=Math.min(MIN_LOG_HEIGHT,available);
  const desiredHeight=Math.max(minHeight,Math.min(available,mainRect.height));
  let viewportCap=null;
  if(typeof window!=="undefined"&&typeof window.innerHeight==="number"){
    const viewportAvailable=window.innerHeight-logRect.top-bottomSpacing;
    if(Number.isFinite(viewportAvailable)){
      viewportCap=Math.max(minHeight,Math.max(0,viewportAvailable));
    }
  }
  const isClamped=viewportCap!==null&&desiredHeight>viewportCap;
  const targetHeight=isClamped?Math.min(desiredHeight,viewportCap):desiredHeight;
  const asideHeight=targetHeight+relativeTop+bottomSpacing;
  const finalAsideHeight=isClamped?asideHeight:Math.max(mainRect.height,asideHeight);
  const size=`${targetHeight}px`;
  logElement.style.maxHeight=size;
  logElement.style.minHeight=`${minHeight}px`;
  logElement.style.height=size;
  asideColumn.style.height=`${finalAsideHeight}px`;
  mainColumn.style.minHeight=`${finalAsideHeight}px`;
  if(isClamped){
    mainColumn.style.maxHeight=`${finalAsideHeight}px`;
    mainColumn.style.overflow="auto";
  }else{
    mainColumn.style.removeProperty("maxHeight");
    mainColumn.style.removeProperty("overflow");
  }
}
function scheduleLogSync(){
  if(logHeightFrame!==null) return;
  logHeightFrame=requestFrame(()=>{
    logHeightFrame=null;
    syncLogHeight();
  });
}
if(typeof ResizeObserver==="function"){
  const observer=new ResizeObserver(()=>scheduleLogSync());
  if(mainColumn) observer.observe(mainColumn);
  if(asideColumn) observer.observe(asideColumn);
}
window.addEventListener("resize",scheduleLogSync);
let pagina=1,tamanho=10,totalPlanos={all:0,passiveis:0},maxPaginas=1;
let paginaOcc=1,totalOcc=0,maxPaginasOcc=1,filtroSituacaoOcc="TODAS";
let timer=null;
let ultimoEstado=null;
let filtroOcorrOutsideHandler=null;
let filtroOcorrScrollHandler=null;
let filtroOcorrResizeHandler=null;
let filtroOcorrKeydownHandler=null;

function abrirModalConclusao(){
  if(!el.modalConcluido) return;
  el.modalConcluido.classList.add("active");
  el.modalConcluido.setAttribute("aria-hidden","false");
  if(el.btnModalOk){
    try{el.btnModalOk.focus();return;}catch(_e){}
  }
  const card=el.modalConcluido?el.modalConcluido.querySelector(".modal-card"):null;
  if(card){
    try{card.focus();}catch(_e){}
  }
}

function fecharModalConclusao(){
  if(!el.modalConcluido) return;
  el.modalConcluido.classList.remove("active");
  el.modalConcluido.setAttribute("aria-hidden","true");
}

function setBar(p){el.barTotal.style.width=`${p}%`;el.lblTotal.textContent=`${p}% concluído`}
function stateButtons(estado){
  const s=String(estado);
  el.btnIniciar.disabled=!(s==="ocioso"||s==="concluido");
  el.btnPausar.disabled=!(s==="executando");
  el.btnContinuar.disabled=!(s==="pausado");
  el.btnContinuar.classList.toggle("primary",s==="pausado");
  el.estadoTexto.textContent=s==="executando"?"Em processamento":s==="pausado"?"Pausado":"Ocioso";
}
async function api(path,opts={}){const r=await fetch(path,{headers:{"Content-Type":"application/json"},...opts});if(!r.ok)throw new Error(await r.text());return r.json()}

function updateFooter(hasData){
  el.footerInfo.textContent=hasData
    ? `exibindo ${tamanho} por pág. • ${totalPlanos.passiveis??0} planos passíveis de rescisão.`
    : "nada a exibir por aqui.";
  el.btnAnterior.disabled=(pagina<=1); el.btnProximo.disabled=(pagina>=maxPaginas);
  el.lblPaginaTotal.textContent=`pág. ${pagina} de ${maxPaginas}`;
}
function updateFooterOcc(hasData){
  el.footerInfoOcc.textContent=hasData
    ? `exibindo ${tamanho} por pág. • ${totalOcc} ocorrências.`
    : "nada a exibir por aqui.";
  el.btnAnteriorOcc.disabled=(paginaOcc<=1); el.btnProximoOcc.disabled=(paginaOcc>=maxPaginasOcc);
  el.lblPaginaTotalOcc.textContent=`pág. ${paginaOcc} de ${maxPaginasOcc}`;
}
function attachCopyHandlers(container){
  container.querySelectorAll(".copy").forEach(a=>{
    a.onclick=async (e)=>{
      e.preventDefault();
      const raw=a.getAttribute("data-copy")||a.textContent.trim();
      const text=a.dataset.copyType==="cnpj"?raw.replace(/\D+/g,""):raw;
      try{
        await navigator.clipboard.writeText(text);
        if(a._copyTimer){clearTimeout(a._copyTimer);a._copyTimer=null;}
        a.classList.remove("copied");
        const raf=(window.requestAnimationFrame?window.requestAnimationFrame.bind(window):(fn)=>setTimeout(fn,0));
        raf(()=>{
          a.classList.add("copied");
          a._copyTimer=setTimeout(()=>{a.classList.remove("copied");a._copyTimer=null;},900);
        });
      }catch{}
    };
  });
}

async function carregarPlanos(){
  const data=await api(`/captura/planos?pagina=${pagina}&tamanho=${tamanho}`);
  const items=data.items||[];
  const totalRegistros=data.total??items.length;
  totalPlanos={all:totalRegistros, passiveis:data.total_passiveis??0};
  maxPaginas=Math.max(1,Math.ceil(totalRegistros/tamanho));
  if(pagina>maxPaginas){pagina=maxPaginas;return carregarPlanos()}
  el.tbody.innerHTML="";
  items.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a class="copy" data-copy="${p.numero_plano}" href="#">${p.numero_plano||""}</a></td>
      <td>${p.gifug||""}</td>
      <td>${p.situacao_atual||""}</td>
      <td>${p.tipo||""}</td>
      <td class="right">${p.dias_em_atraso??""}</td>
      <td class="right">${fmtMoney(p.saldo)}</td>
      <td>${formatDateBR(p.dt_situacao_atual)}</td>`;
    el.tbody.appendChild(tr);
  });
  attachCopyHandlers(el.tbody);
  updateFooter(totalRegistros>0);
  scheduleLogSync();
}

async function carregarOcorrencias(){
  const params=new URLSearchParams({pagina:String(paginaOcc),tamanho:String(tamanho)});
  if(filtroSituacaoOcc&&filtroSituacaoOcc!=="TODAS"){
    params.set("situacao",filtroSituacaoOcc);
  }
  const data=await api(`/captura/ocorrencias?${params.toString()}`);
  const items=data.items||[];
  const totalRegistros=data.total??items.length;
  totalOcc=totalRegistros;
  maxPaginasOcc=Math.max(1,Math.ceil(totalRegistros/tamanho));
  if(paginaOcc>maxPaginasOcc){paginaOcc=maxPaginasOcc;return carregarOcorrencias()}
  el.tbodyOcc.innerHTML="";
  items.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a class="copy" data-copy="${p.numero_plano}" href="#">${p.numero_plano}</a></td>
      <td>${p.situacao}</td>
      <td><a class="copy" data-copy="${p.cnpj}" data-copy-type="cnpj" href="#">${p.cnpj}</a></td>
      <td>${p.tipo||""}</td>
      <td class="right">${fmtMoney(p.saldo)}</td>
      <td>${formatDateBR(p.dt_situacao_atual)}</td>`;
    el.tbodyOcc.appendChild(tr);
  });
  attachCopyHandlers(el.tbodyOcc);
  updateFooterOcc(totalRegistros>0);
  atualizarFiltroOcorrMenu();
  scheduleLogSync();
}

function atualizarFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  const options=el.filtroOcorrMenu.querySelectorAll(".filter-option");
  let activeLabel="";
  options.forEach(option=>{
    const value=option.getAttribute("data-value")||"";
    const isActive=value===filtroSituacaoOcc;
    option.classList.toggle("active",isActive);
    option.setAttribute("aria-checked",isActive?"true":"false");
    if(isActive){
      activeLabel=option.textContent.trim();
    }
  });
  const fallbackLabel=options.length>0?options[0].textContent.trim():"";
  const currentLabel=activeLabel||fallbackLabel;
  if(el.filtroOcorrToggle){
    const baseLabel="Filtrar ocorrências por situação";
    const suffix=currentLabel?` (atual: ${currentLabel})`:"";
    el.filtroOcorrToggle.setAttribute("title",baseLabel+suffix);
    el.filtroOcorrToggle.setAttribute("aria-label",baseLabel+suffix);
  }
  if(el.filtroOcorrTrigger){
    const triggerTitle=currentLabel?`Situação (atual: ${currentLabel})`:"Situação";
    el.filtroOcorrTrigger.setAttribute("title",triggerTitle);
    el.filtroOcorrTrigger.setAttribute("aria-label",triggerTitle);
  }
}

function posicionarFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu||!el.filtroOcorrTrigger) return;
  const triggerRect=el.filtroOcorrTrigger.getBoundingClientRect();
  const minWidth=160;
  const margin=12;
  const viewportWidth=window.innerWidth||document.documentElement.clientWidth||0;
  const width=Math.max(minWidth,triggerRect.width);
  let left=triggerRect.left;
  if(left+width+margin>viewportWidth){
    left=Math.max(margin,viewportWidth-width-margin);
  }
  el.filtroOcorrMenu.style.minWidth=`${Math.round(width)}px`;
  el.filtroOcorrMenu.style.left=`${Math.round(left)}px`;
  let top=triggerRect.bottom+6;
  el.filtroOcorrMenu.style.top=`${Math.round(top)}px`;
  const menuRect=el.filtroOcorrMenu.getBoundingClientRect();
  const viewportHeight=window.innerHeight||document.documentElement.clientHeight||0;
  if(menuRect.bottom>viewportHeight-margin){
    const adjustedTop=Math.max(margin,triggerRect.top-menuRect.height-6);
    el.filtroOcorrMenu.style.top=`${Math.round(adjustedTop)}px`;
  }
}

function abrirFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  if(!el.filtroOcorrMenu.classList.contains("open")){
    el.filtroOcorrMenu.classList.add("open");
    if(el.filtroOcorrToggle){
      el.filtroOcorrToggle.setAttribute("aria-expanded","true");
      el.filtroOcorrToggle.classList.add("open");
    }
    if(!filtroOcorrOutsideHandler){
      filtroOcorrOutsideHandler=(event)=>{
        const target=event.target;
        if(el.filtroOcorrMenu&&el.filtroOcorrMenu.contains(target)) return;
        if(el.filtroOcorrToggle&&el.filtroOcorrToggle.contains(target)) return;
        if(el.filtroOcorrTrigger&&el.filtroOcorrTrigger.contains(target)) return;
        fecharFiltroOcorrMenu();
      };
      document.addEventListener("mousedown",filtroOcorrOutsideHandler);
      document.addEventListener("touchstart",filtroOcorrOutsideHandler);
    }
    if(!filtroOcorrScrollHandler){
      filtroOcorrScrollHandler=()=>fecharFiltroOcorrMenu();
      window.addEventListener("scroll",filtroOcorrScrollHandler,true);
    }
    if(!filtroOcorrResizeHandler){
      filtroOcorrResizeHandler=()=>{
        if(el.filtroOcorrMenu&&el.filtroOcorrMenu.classList.contains("open")){
          posicionarFiltroOcorrMenu();
        }
      };
      window.addEventListener("resize",filtroOcorrResizeHandler);
    }
    if(!filtroOcorrKeydownHandler){
      filtroOcorrKeydownHandler=(event)=>{
        if(event.key==="Escape"){
          fecharFiltroOcorrMenu();
          if(el.filtroOcorrToggle){
            try{el.filtroOcorrToggle.focus({preventScroll:true});}catch(_e){}
          }
        }
      };
      document.addEventListener("keydown",filtroOcorrKeydownHandler);
    }
  }
  posicionarFiltroOcorrMenu();
  const activeOption=el.filtroOcorrMenu.querySelector(".filter-option.active");
  if(activeOption){
    try{activeOption.focus({preventScroll:true});}catch(_e){}
  }
}

function fecharFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  if(!el.filtroOcorrMenu.classList.contains("open")) return;
  el.filtroOcorrMenu.classList.remove("open");
  el.filtroOcorrMenu.style.removeProperty("left");
  el.filtroOcorrMenu.style.removeProperty("top");
  el.filtroOcorrMenu.style.removeProperty("minWidth");
  if(el.filtroOcorrToggle){
    el.filtroOcorrToggle.setAttribute("aria-expanded","false");
    el.filtroOcorrToggle.classList.remove("open");
  }
  if(filtroOcorrOutsideHandler){
    document.removeEventListener("mousedown",filtroOcorrOutsideHandler);
    document.removeEventListener("touchstart",filtroOcorrOutsideHandler);
    filtroOcorrOutsideHandler=null;
  }
  if(filtroOcorrScrollHandler){
    window.removeEventListener("scroll",filtroOcorrScrollHandler,true);
    filtroOcorrScrollHandler=null;
  }
  if(filtroOcorrResizeHandler){
    window.removeEventListener("resize",filtroOcorrResizeHandler);
    filtroOcorrResizeHandler=null;
  }
  if(filtroOcorrKeydownHandler){
    document.removeEventListener("keydown",filtroOcorrKeydownHandler);
    filtroOcorrKeydownHandler=null;
  }
}

function alternarFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  if(el.filtroOcorrMenu.classList.contains("open")){
    fecharFiltroOcorrMenu();
  }else{
    abrirFiltroOcorrMenu();
  }
}

function formatLogMessage(item){
  const dataHora=formatDateTime(item.timestamp,{
    day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"
  });
  const numero=(item.numero_plano||"").trim();
  const mensagem=(item.mensagem||"").trim();
  let corpo="";
  if(mensagem==="Capturado com sucesso"&&numero){
    corpo=`${numero} processado com sucesso.`;
  }else if(mensagem.startsWith("Descartado")&&numero){
    corpo=`${numero} possui ocorrência.`;
  }else if(mensagem==="Falha inesperada"&&numero){
    corpo=`${numero} falhou no processamento.`;
  }else if(mensagem){
    corpo=numero?`${numero} — ${mensagem}`:mensagem;
  }else{
    corpo=numero;
  }
  if(!corpo) return "";
  return dataHora?`[${dataHora}] ${corpo}`:corpo;
}

function renderLog(_emProgresso, historico){
  const container=el.log;
  const prevScrollTop=container.scrollTop;
  const nearBottom=(container.scrollHeight - (container.scrollTop + container.clientHeight))<=8;
  container.innerHTML="";
  const frag=document.createDocumentFragment();
  historico.forEach(item=>{
    const texto=formatLogMessage(item);
    if(!texto) return;
    const div=document.createElement("p");
    div.textContent=texto;
    div.classList.add("log-history");
    frag.appendChild(div);
  });
  container.appendChild(frag);
  if(nearBottom){
    container.scrollTop=container.scrollHeight;
  }else{
    const maxScroll=Math.max(0,container.scrollHeight-container.clientHeight);
    container.scrollTop=Math.min(prevScrollTop,maxScroll);
  }
  scheduleLogSync();
}

async function carregarStatus(){
  const s=await api("/captura/status");
  const estadoAtual=s.estado;
  stateButtons(estadoAtual); setBar(s.progresso_total);
  renderLog(s.em_progresso||[], s.historico||[]);
  const ultimaAtualizacao=formatDateTime(s.ultima_atualizacao);
  el.ultima.textContent="Última atualização: "+(ultimaAtualizacao||"—");
  el.badgeOcorr.textContent = s.ocorrencias_total ?? 0;
  if(ultimoEstado && ultimoEstado!=="concluido" && estadoAtual==="concluido"){
    abrirModalConclusao();
  }
  ultimoEstado=estadoAtual;
}

function startPolling(){
  if(timer) clearInterval(timer);
  timer=setInterval(async()=>{ try{
    await carregarStatus();
    if(document.getElementById("wrapPlanos").style.display!=="none") await carregarPlanos();
    else await carregarOcorrencias();
  }catch(e){console.error(e)} },2000);
}

el.btnIniciar.onclick=async()=>{await api("/captura/iniciar",{method:"POST"});await carregarStatus();startPolling()};
el.btnPausar.onclick=async()=>{await api("/captura/pausar",{method:"POST"});await carregarStatus()};
el.btnContinuar.onclick=async()=>{await api("/captura/continuar",{method:"POST"});await carregarStatus()};
el.btnProximo.onclick=()=>{if(pagina<maxPaginas){pagina+=1;carregarPlanos()}};
el.btnAnterior.onclick=()=>{if(pagina>1){pagina-=1;carregarPlanos()}};
el.btnProximoOcc.onclick=()=>{if(paginaOcc<maxPaginasOcc){paginaOcc+=1;carregarOcorrencias()}};
el.btnAnteriorOcc.onclick=()=>{if(paginaOcc>1){paginaOcc-=1;carregarOcorrencias()}};

el.subtabPlanos.onclick=()=>{fecharFiltroOcorrMenu();el.subtabPlanos.classList.add("active");el.subtabOcorr.classList.remove("active");$("#wrapPlanos").style.display="block";$("#wrapOcorr").style.display="none";scheduleLogSync();};
el.subtabOcorr.onclick=()=>{fecharFiltroOcorrMenu();el.subtabOcorr.classList.add("active");el.subtabPlanos.classList.remove("active");$("#wrapPlanos").style.display="none";$("#wrapOcorr").style.display="block";carregarOcorrencias();scheduleLogSync();};

if(el.filtroOcorrToggle){
  el.filtroOcorrToggle.addEventListener("click",event=>{
    event.preventDefault();
    event.stopPropagation();
    alternarFiltroOcorrMenu();
  });
}
if(el.filtroOcorrTrigger){
  el.filtroOcorrTrigger.addEventListener("click",event=>{
    if(event.target&&event.target.closest(".filter-toggle")) return;
    event.preventDefault();
    alternarFiltroOcorrMenu();
  });
}
if(el.filtroOcorrMenu){
  el.filtroOcorrMenu.querySelectorAll(".filter-option").forEach(option=>{
    option.addEventListener("click",event=>{
      event.preventDefault();
      event.stopPropagation();
      const value=option.getAttribute("data-value")||"";
      if(!value) return;
      if(value!==filtroSituacaoOcc){
        filtroSituacaoOcc=value;
        paginaOcc=1;
        atualizarFiltroOcorrMenu();
        carregarOcorrencias();
      }
      fecharFiltroOcorrMenu();
    });
  });
}

atualizarFiltroOcorrMenu();

if(el.btnModalOk){
  el.btnModalOk.addEventListener("click",()=>{
    fecharModalConclusao();
  });
}

if(el.btnModalClose){
  el.btnModalClose.addEventListener("click",()=>{
    fecharModalConclusao();
  });
}

document.addEventListener("keydown",event=>{
  if(event.key==="Escape"&&el.modalConcluido&&el.modalConcluido.classList.contains("active")){
    fecharModalConclusao();
  }
});

document.addEventListener("DOMContentLoaded", async()=>{await carregarStatus();await carregarPlanos();startPolling();scheduleLogSync();});
</script>
</body>
</html>
