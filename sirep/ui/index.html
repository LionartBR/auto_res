<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>SIREP 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--accent:#0039BA;--text:#111;--muted:#6b7280;--line:#e5e7eb;--bg:#fff;--hdr-a:#0B5FA8;--hdr-b:#108CBC;--hdr-c:#49C3B6;--prog-a:#ef7d00;--prog-b:#F7A600}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--hdr-a),var(--hdr-b),var(--hdr-c));color:#fff}
    .top{display:flex;align-items:center;justify-content:center;padding:12px 16px;position:relative}
    .top h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.5px}
    .top .icons{position:absolute;right:12px;display:flex;gap:12px}
    .icon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,.12);cursor:pointer}
    main{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tab{padding:12px 16px;cursor:pointer;font-weight:600;font-size:15px;border-bottom:2px solid transparent}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .content{padding:16px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .progress-row{display:flex;flex-direction:column;align-items:flex-start;gap:6px;margin-top:8px;width:100%}
    button{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);padding:9px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    select{border:1px solid var(--line);background:#fff;color:var(--text);padding:8px 12px;border-radius:10px;font-weight:600;min-width:160px}
    select:focus{outline:2px solid rgba(16,140,188,.25);outline-offset:1px}
    #btnIniciar,#btnContinuar,#btnTratamentoIniciar,#btnTratamentoContinuar{padding:9px 14px;font-size:14px;border-radius:10px}
    button.primary{border:0;color:#fff;background:#108CBC;box-shadow:none;transition:transform .15s ease,background-color .15s ease}
    button.primary:hover:not(:disabled){background:#0b749f;transform:translateY(-1px)}
    #btnContinuar:not(.primary),#btnTratamentoContinuar:not(.primary){background:#f3f4f6;color:var(--muted);border-color:#d1d5db}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .progress{height:10px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;overflow:hidden;width:100%;min-width:220px;flex:1 1 auto}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--prog-a),var(--prog-b));position:relative;transition:width .2s ease}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--line)}
    th{text-align:left;font-size:12px;color:#4b5563;font-weight:700;letter-spacing:.3px}
    .right{text-align:right}
    th.filterable{position:relative}
    .th-filter{display:inline-flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
    .th-filter.no-toggle{cursor:default}
    .th-filter-label{display:flex;flex-direction:column;line-height:1}
    .filter-toggle{border:0;background:transparent;width:22px;height:22px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;padding:0;transition:background-color .2s ease}
    .th-filter:hover .filter-toggle,.filter-toggle:focus-visible{background:rgba(16,140,188,.12);outline:none}
    .filter-toggle svg{width:12px;height:12px;stroke:#4b5563;stroke-width:2;fill:none;transition:transform .2s ease}
    .filter-toggle.open svg{transform:rotate(180deg)}
    .filter-menu{position:fixed;top:auto;left:auto;min-width:160px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 14px 32px rgba(15,23,42,.18);padding:6px;display:none;z-index:200}
    .filter-menu.open{display:block}
    .filter-option{display:flex;width:100%;padding:8px 10px;border:0;background:transparent;font-weight:600;color:var(--text);border-radius:8px;cursor:pointer;text-align:left}
    .filter-option:hover,.filter-option:focus-visible{background:rgba(16,140,188,.12);outline:none}
    .filter-option.active{color:var(--accent);background:rgba(16,140,188,.08)}
    /* grid vira 1 coluna */
    .grid{display:grid;grid-template-columns:1fr;gap:16px;align-items:stretch}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .grid > div{display:flex;flex-direction:column;min-height:0}
    /* Card de logs */
    .logs-card{margin-top:16px;border-radius:14px;border:1px solid var(--line);overflow:hidden}
    .logs-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;background:#fff;cursor:pointer;user-select:none;
      border-bottom:1px solid var(--line)
    }
    .logs-header:focus{outline:2px solid rgba(16,140,188,.25);outline-offset:2px}
    .logs-title{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--text)}
    .logs-title .caret{display:inline-block;transition:transform .18s ease;transform-origin:center}
    .logs-header[aria-expanded="true"] .caret{transform:rotate(90deg)}

    .logs-actions{display:flex;gap:8px;align-items:center;}
    .logs-actions input[type="date"]{
      padding:6px 8px;border:1px solid var(--line);border-radius:8px;font:inherit
    }
    .btn-export{
      appearance:none;border:0;background:#108CBC;color:#fff;font-weight:700;
      padding:8px 12px;border-radius:10px;cursor:pointer
    }
    .btn-export:hover{background:#0b749f}
    .btn-export:disabled{opacity:.5;cursor:not-allowed}

    .logs-body{background:#fff}
    .logs-table-wrap{
      /* Altura fixa no abrir + rolagem interna */
      height:300px;overflow:auto;padding:10px 12px;
    }
    .logs-table{width:100%;border-collapse:collapse}
    .logs-table th,.logs-table td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:13px}
    .logs-table th{text-align:left;font-size:12px;color:#4b5563;font-weight:700;letter-spacing:.3px}

    /* badges por status */
    .badge-status{
      display:inline-block;padding:2px 8px;border-radius:999px;font-weight:800;font-size:11px;
      border:1px solid transparent
    }
    .badge-status.sucesso{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .badge-status.falha{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .badge-status.descartado{background:#fffbeb;color:#92400e;border-color:#fde68a}

    .logs-footer{padding:8px 12px 12px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .page-footer{margin:48px auto 24px;text-align:center;font-size:12px;color:var(--muted);line-height:1.6}
    .page-footer p{margin:0}
    .state{font-weight:700}
    /* sub-abas dentro da seção */
    .subtabs{display:flex;gap:14px;align-items:center;margin:12px 0 6px}
    .subtab{font-weight:700;opacity:.6;cursor:pointer}
    .subtab.active{color:var(--accent);opacity:1}
    .badge{display:inline-block;min-width:18px;padding:0 6px;border-radius:999px;background:#fef2f2;color:#b91c1c;font-weight:800;font-size:11px;border:1px solid #fecaca;vertical-align:middle;margin-left:6px}
    /* link copyable */
    .copy{color:#0b5fa8;cursor:pointer;text-decoration:underline;position:relative;display:inline-block}
    .copy.copied{color:#16a34a;text-decoration:none}
    .copy.copied::after{content:"item copiado";position:absolute;left:50%;top:-32px;transform:translateX(-50%);background:rgba(17,17,17,.92);color:#fff;font-size:11px;font-weight:600;padding:4px 8px;border-radius:6px;white-space:nowrap;box-shadow:0 4px 10px rgba(0,0,0,.18);pointer-events:none;animation:copy-tooltip .9s ease;z-index:20}
    .copy.copied::before{content:"";position:absolute;left:50%;top:-10px;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(17,17,17,.92);pointer-events:none;animation:copy-tooltip-arrow .9s ease;z-index:19}
    @keyframes copy-tooltip{0%{opacity:0;transform:translate(-50%,-4px)}20%{opacity:1;transform:translate(-50%,-10px)}80%{opacity:1;transform:translate(-50%,-12px)}100%{opacity:0;transform:translate(-50%,-14px)}}
    @keyframes copy-tooltip-arrow{0%{opacity:0;transform:translate(-50%,2px)}20%{opacity:1;transform:translate(-50%,0)}80%{opacity:1;transform:translate(-50%,-1px)}100%{opacity:0;transform:translate(-50%,-2px)}}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50;padding:16px}
    .modal-backdrop.active{display:flex}
    .modal-window{background:#f7f7f7;border:1px solid rgba(17,24,39,.18);box-shadow:0 18px 36px rgba(15,23,42,.28);max-width:320px;min-width:260px;width:100%;font-family:inherit;outline:none}
    .modal-window[role="document"]:focus{outline:2px solid rgba(16,140,188,.4);outline-offset:-4px}
    .modal-titlebar{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--hdr-a),var(--hdr-b),var(--hdr-c));color:#fff;padding:6px 10px;font-size:13px;font-weight:600;letter-spacing:.2px}
    .modal-titlebar .modal-title{margin:0;min-height:1em}
    .modal-window button{font-family:inherit;font-weight:600;border-radius:0;background:#fff;border:1px solid rgba(17,24,39,.18);box-shadow:none;cursor:pointer;transition:none;color:#111;padding:6px 12px}
    .modal-window button:focus-visible{outline:2px solid rgba(16,140,188,.4);outline-offset:2px}
    .modal-window button:active{background:#f3f4f6}
    .modal-close{margin-left:12px;min-width:auto;width:22px;height:22px;padding:0;line-height:1;font-size:12px;display:inline-flex;align-items:center;justify-content:center}
    .modal-body{padding:24px 20px;background:#f7f7f7}
    .modal-body p{margin:0;font-size:14px;font-weight:400;color:#000}
    .modal-actions{display:flex;justify-content:center;padding:0 20px 18px;background:#f7f7f7}
    .modal-actions .modal-button{min-width:96px;font-size:13px}

    /* Tratamentos */
    .treatment-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .treatment-controls .muted{margin-left:4px}
    .treatment-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .treatment-actions input[type="date"]{padding:6px 10px;border:1px solid var(--line);border-radius:8px;font:inherit}
    .treatment-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .treatment-column{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
    #treatmentQueueTable{width:100%;border-collapse:collapse}
    #treatmentQueueTable th,#treatmentQueueTable td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:13px;text-align:left}
    #treatmentQueueTable th{font-size:12px;color:#4b5563;font-weight:700;letter-spacing:.3px}
    #treatmentQueueTable tbody tr:last-child td{border-bottom:0}
    .queue-row.current{background:rgba(16,140,188,.08)}
    .queue-row.rescindido{background:#ecfdf5}
    .queue-row.descartado{background:#fef2f2}
    .queue-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700;background:#f3f4f6;color:#111;text-transform:uppercase}
    .treatment-summary{display:flex;flex-direction:column;gap:4px;font-size:13px;color:#111}
    .treatment-summary strong{font-weight:800}
    .treatment-empty{font-size:13px;color:var(--muted)}
    .stage-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}
    .stage{border:1px solid var(--line);border-left-width:4px;border-radius:10px;padding:10px 12px;background:#f9fafb}
    .stage-header{display:flex;justify-content:space-between;gap:10px;font-weight:700;font-size:13px;margin-bottom:4px}
    .stage-status-label{font-weight:800;font-size:11px;text-transform:uppercase;color:var(--muted)}
    .stage-dates{font-size:11px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;margin-top:4px}
    .stage.processando{border-left-color:#F7A600;background:#fff7ed}
    .stage.processando .stage-status-label{color:#b45309}
    .stage.concluido{border-left-color:#16a34a;background:#ecfdf5}
    .stage.concluido .stage-status-label{color:#047857}
    .stage.cancelado{border-left-color:#b91c1c;background:#fef2f2}
    .stage.cancelado .stage-status-label{color:#b91c1c}
    .stage.pendente{border-left-color:#d1d5db}
    .treatment-downloads{display:flex;gap:10px;align-items:center;margin-top:6px}
    .treatment-logs{margin-top:20px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
    .treatment-logs table{width:100%;border-collapse:collapse}
    .treatment-logs th,.treatment-logs td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:12px;text-align:left}
    .treatment-logs th{font-size:12px;color:#4b5563;font-weight:700;letter-spacing:.3px}
    .treatment-logs tbody tr:last-child td{border-bottom:0}
    .btn-link{appearance:none;border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer}
    .btn-link:hover{background:rgba(16,140,188,.08)}
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>SIREP 2.0</h1>
    <div class="icons">
      <div class="icon" title="Configurações" aria-label="Configurações">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V22a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.04 2.4l.06.06a1.65 1.65 0 0 0 1.82.33H8a1.65 1.65 0 0 0 1-1.51V2a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V8c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73H22a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </div>
      <div class="icon" title="Conta" aria-label="Conta">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="gestao">Gestão da Base</div>
      <div class="tab" data-tab="tratamento">Tratamento</div>
    </div>
    <div class="content">
      <section id="tab-gestao">
        <div class="grid">
          <div>
            <div class="row" style="margin-bottom:10px;">
              <div class="controls">
                <button id="btnIniciar" class="primary">Iniciar</button>
                <button id="btnPausar">Pausar</button>
                <button id="btnContinuar" disabled>Continuar</button>
              </div>
            </div>
            <div class="muted">Status: <span id="estadoTexto">Ocioso</span></div>
            <div class="progress-row">
              <div class="progress" title="Progresso total"><div id="barTotal" style="width:0%"></div></div>
              <span id="lblTotal" class="muted">0% concluído</span>
            </div>

            <div class="muted" id="ultimaAtualizacao">Última atualização: —</div>

            <div class="subtabs">
              <span class="subtab active" id="subtabPlanos">Planos capturados</span>
              <span class="subtab" id="subtabOcorr">Ocorrências <span class="badge" id="badgeOcorr">0</span></span>
            </div>

            <!-- Tabela Planos -->
            <div id="wrapPlanos">
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th scope="col">CARTEIRA</th>
                    <th scope="col">GIFUG</th>
                    <th class="filterable" scope="col">
                      <div class="th-filter no-toggle">
                        <div class="th-filter-label">
                          <span>SITUAÇÃO</span>
                        </div>
                      </div>
                    </th>
                    <th scope="col">TIPO</th>
                    <th class="right" scope="col">DIAS EM ATRASO</th>
                    <th class="right" scope="col">SALDO</th>
                    <th scope="col">DT SITUAÇÃO</th>
                  </tr></thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
              <div class="footer">
                <div class="muted" id="footerInfo">nada a exibir por aqui.</div>
                <div><button id="btnAnterior">Anterior</button><span class="muted" id="lblPaginaTotal" style="margin:0 6px">pág. 1 de 1</span><button id="btnProximo">Próximo</button></div>
              </div>
            </div>

            <!-- Tabela Ocorrências -->
            <div id="wrapOcorr" style="display:none">
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th>CARTEIRA</th>
                    <th class="filterable" scope="col">
                      <div class="th-filter" id="filtroOcorrTrigger">
                        <div class="th-filter-label">
                          <span>SITUAÇÃO</span>
                        </div>
                        <button type="button" class="filter-toggle" id="filtroOcorrToggle" aria-haspopup="true" aria-expanded="false" aria-controls="filtroOcorrMenu" aria-label="Filtrar ocorrências por situação" title="Filtrar ocorrências por situação">
                          <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true"><path d="M3 4.5 6 7.5l3-3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                      </div>
                    </th>
                    <th>CNPJ</th><th>TIPO</th><th class="right">SALDO</th><th>DT SITUAÇÃO</th>
                  </tr></thead>
                  <tbody id="tbodyOcc"></tbody>
                </table>
              </div>
              <div class="filter-menu" id="filtroOcorrMenu" role="menu" aria-labelledby="filtroOcorrTrigger">
                <button type="button" class="filter-option active" data-value="TODAS" role="menuitemradio" aria-checked="true">Todas</button>
                <button type="button" class="filter-option" data-value="SIT ESPECIAL" role="menuitemradio" aria-checked="false">Sit especial</button>
                <button type="button" class="filter-option" data-value="LIQUIDADO" role="menuitemradio" aria-checked="false">Liquidado</button>
                <button type="button" class="filter-option" data-value="RESCINDIDO" role="menuitemradio" aria-checked="false">Rescindido</button>
                <button type="button" class="filter-option" data-value="GRDE Emitida" role="menuitemradio" aria-checked="false">GRDE emitida</button>
              </div>
              <div class="footer">
                <div class="muted" id="footerInfoOcc">nada a exibir por aqui.</div>
                <div><button id="btnAnteriorOcc">Anterior</button><span class="muted" id="lblPaginaTotalOcc" style="margin:0 6px">pág. 1 de 1</span><button id="btnProximoOcc">Próximo</button></div>
              </div>
            </div>

            <!-- Card de Eventos (logs) -->
            <div id="cardLogs" class="card logs-card" aria-live="polite">
              <div class="logs-header" id="logsHeader" role="button" tabindex="0" aria-expanded="false" aria-controls="logsBody" title="Mostrar/ocultar janela de eventos (logs)">
                <div class="logs-title">
                  <span class="caret" aria-hidden="true">▶</span>
                  <strong>Janela de Eventos (logs)</strong>
                </div>

                <div class="logs-actions">
                  <label class="muted" for="logsFrom">De:</label>
                  <input type="date" id="logsFrom" aria-label="Data inicial" />
                  <label class="muted" for="logsTo">Até:</label>
                  <input type="date" id="logsTo" aria-label="Data final" />
                  <button id="btnExportLogs" class="btn-export" title="Exportar logs em Excel (.xlsx)">Exportar (.xlsx)</button>
                </div>
              </div>

              <div class="logs-body" id="logsBody" hidden>
                <div class="logs-table-wrap">
                  <table class="logs-table" aria-label="Últimos eventos">
                    <thead>
                      <tr>
                        <th scope="col">Etapa de execução</th>
                        <th scope="col">Número do plano</th>
                        <th scope="col">Status</th>
                        <th scope="col">Usuário responsável</th>
                        <th scope="col">Duração</th>
                        <th scope="col">Data e hora</th>
                      </tr>
                    </thead>
                    <tbody id="tbodyLogs"></tbody>
                  </table>
                </div>
                <div class="logs-footer muted">Exibindo os 10 eventos mais recentes. Novos eventos aparecem automaticamente.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-tratamento" style="display:none">
        <div class="treatment-controls">
          <button id="btnTratamentoSeed">Migrar planos</button>
          <button id="btnTratamentoIniciar" class="primary">Iniciar</button>
          <button id="btnTratamentoPausar">Pausar</button>
          <button id="btnTratamentoContinuar" disabled>Continuar</button>
          <span class="muted">Estado: <span id="tratamentoEstado">Ocioso</span></span>
        </div>
        <div class="treatment-actions">
          <label class="muted" for="inputRescindidosData">Data para exportação:</label>
          <input type="date" id="inputRescindidosData" aria-label="Data de rescisão" />
          <button id="btnDownloadRescindidos" class="btn-link">Exportar Rescindidos_CNPJ.txt</button>
        </div>
        <div class="treatment-grid">
          <div class="treatment-column" aria-live="polite">
            <h3>Fila de planos</h3>
            <div class="muted">Enquanto um plano estiver em tratamento os demais aguardam.</div>
            <table id="treatmentQueueTable" aria-label="Fila de tratamentos">
              <thead>
                <tr>
                  <th scope="col">Plano</th>
                  <th scope="col">Razão social</th>
                  <th scope="col">Status</th>
                  <th scope="col">Etapa atual</th>
                  <th scope="col">Ações</th>
                </tr>
              </thead>
              <tbody id="tbodyTratamentoFila"></tbody>
            </table>
            <div id="tratamentoEmpty" class="treatment-empty" hidden>Nenhum plano em tratamento. Migre planos para iniciar.</div>
          </div>
          <div class="treatment-column">
            <h3>Plano em execução</h3>
            <div id="tratamentoAtualResumo" class="treatment-summary">Selecione ou aguarde um plano iniciar.</div>
            <ul id="listaEtapas" class="stage-list"></ul>
            <div class="treatment-downloads">
              <button id="btnDownloadNotepad" class="btn-link" disabled>Baixar bloco de notas (.txt)</button>
            </div>
          </div>
        </div>
        <div class="treatment-logs">
          <h3>Logs das etapas</h3>
          <table aria-label="Eventos de tratamento">
            <thead>
              <tr>
                <th scope="col">Data e hora</th>
                <th scope="col">Plano</th>
                <th scope="col">Etapa</th>
                <th scope="col">Status</th>
                <th scope="col">Mensagem</th>
              </tr>
            </thead>
            <tbody id="tbodyTratamentoLogs"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</main>

<div class="modal-backdrop" id="modalConcluido" role="dialog" aria-modal="true" aria-labelledby="modalConcluidoMensagem" aria-describedby="modalConcluidoMensagem" aria-hidden="true">
  <div class="modal-window" role="document" tabindex="-1">
    <div class="modal-titlebar">
      <span class="modal-title" aria-hidden="true"></span>
      <button type="button" id="btnModalClose" class="modal-close" aria-label="Fechar aviso">x</button>
    </div>
    <div class="modal-body">
      <p id="modalConcluidoMensagem">Processamento concluído!</p>
    </div>
    <div class="modal-actions">
      <button type="button" id="btnModalOk" class="modal-button">Ok</button>
    </div>
  </div>
</div>

<footer class="page-footer" aria-label="Informações de desenvolvimento">
  <p>Desenvolvido por:</p>
  <p>CEFGD/RJ – Recuperação de Débitos do FGTS Perante o Empregador</p>
  <p>CAIXA™ - 2025</p>
</footer>

<script>
function $(selector){ return document.querySelector(selector); }
const fmtMoney=n=>n==null?"":Number(n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
function formatDateBR(value){
  if(!value) return "";
  if(value instanceof Date&&!Number.isNaN(value.getTime())){
    const day=String(value.getDate()).padStart(2,"0");
    const month=String(value.getMonth()+1).padStart(2,"0");
    const year=value.getFullYear();
    return `${day}/${month}/${year}`;
  }
  const str=String(value).trim();
  if(!str) return "";
  const isoMatch=str.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s]|$)/);
  if(isoMatch){
    return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
  }
  const timestamp=Date.parse(str);
  if(!Number.isNaN(timestamp)){
    const date=new Date(timestamp);
    if(!Number.isNaN(date.getTime())){
      const day=String(date.getDate()).padStart(2,"0");
      const month=String(date.getMonth()+1).padStart(2,"0");
      const year=date.getFullYear();
      return `${day}/${month}/${year}`;
    }
  }
  return str;
}
const TIMEZONE="America/Sao_Paulo";
function formatDateTime(value,options){
  if(!value)return"";
  const date=new Date(value);
  if(Number.isNaN(date.getTime()))return"";
  const opts={timeZone:TIMEZONE,...(options||{})};
  return date.toLocaleString("pt-BR",opts);
}
const TREATMENT_STAGE_NAMES={
  1:"Etapa 1 – Aproveitamento de Recolhimentos",
  2:"Etapa 2 – Substituição – Confissão x Notificação Fiscal",
  3:"Etapa 3 – Pesquisa de Guias no SFG (PIG)",
  4:"Etapa 4 – Lançamento de Guias no FGE (PIG)",
  5:"Etapa 5 – Situação do Plano",
  6:"Etapa 6 – Rescisão",
  7:"Etapa 7 – Comunicação da Rescisão"
};
const el={
  btnIniciar:$("#btnIniciar"), btnPausar:$("#btnPausar"), btnContinuar:$("#btnContinuar"),
  barTotal:$("#barTotal"), lblTotal:$("#lblTotal"), ultima:$("#ultimaAtualizacao"),
  tbody:$("#tbody"), btnProximo:$("#btnProximo"), btnAnterior:$("#btnAnterior"),
  lblPaginaTotal:$("#lblPaginaTotal"), footerInfo:$("#footerInfo"),
  tbodyOcc:$("#tbodyOcc"), btnProximoOcc:$("#btnProximoOcc"), btnAnteriorOcc:$("#btnAnteriorOcc"),
  lblPaginaTotalOcc:$("#lblPaginaTotalOcc"), footerInfoOcc:$("#footerInfoOcc"),
  filtroOcorrToggle:$("#filtroOcorrToggle"), filtroOcorrMenu:$("#filtroOcorrMenu"),
  filtroOcorrTrigger:$("#filtroOcorrTrigger"),
  estadoTexto:$("#estadoTexto"),
  subtabPlanos:$("#subtabPlanos"), subtabOcorr:$("#subtabOcorr"), badgeOcorr:$("#badgeOcorr"),
  modalConcluido:$("#modalConcluido"), btnModalOk:$("#btnModalOk"), btnModalClose:$("#btnModalClose"),
  logsCard:$("#cardLogs"), logsHeader:$("#logsHeader"), logsBody:$("#logsBody"),
  tbodyLogs:$("#tbodyLogs"), logsFrom:$("#logsFrom"), logsTo:$("#logsTo"), btnExportLogs:$("#btnExportLogs"),
  tratamentoEstado:$("#tratamentoEstado"), btnTratamentoSeed:$("#btnTratamentoSeed"),
  btnTratamentoIniciar:$("#btnTratamentoIniciar"), btnTratamentoPausar:$("#btnTratamentoPausar"),
  btnTratamentoContinuar:$("#btnTratamentoContinuar"), tbodyTratamentoFila:$("#tbodyTratamentoFila"),
  listaEtapas:$("#listaEtapas"), tratamentoResumo:$("#tratamentoAtualResumo"),
  btnDownloadNotepad:$("#btnDownloadNotepad"), tratamentoEmpty:$("#tratamentoEmpty"),
  tbodyTratamentoLogs:$("#tbodyTratamentoLogs"), inputRescindidosData:$("#inputRescindidosData"),
  btnDownloadRescindidos:$("#btnDownloadRescindidos")
};
let pagina=1,tamanho=10,totalPlanos={all:0,passiveis:0},maxPaginas=1;
let paginaOcc=1,totalOcc=0,maxPaginasOcc=1,filtroSituacaoOcc="TODAS";
let timer=null;
let ultimoEstado=null;
let filtroOcorrOutsideHandler=null;
let filtroOcorrScrollHandler=null;
let filtroOcorrResizeHandler=null;
let filtroOcorrKeydownHandler=null;
let logsOpen=false;
let latestLogs=[];
const MAX_LOGS=10;
let tratamentoTimer=null;
let tratamentoDados=null;
let tratamentoLoading=false;
let activeTab=null;

function statusClass(s){
  const k=(s||"").toLowerCase();
  if(k.includes("sucesso")) return "sucesso";
  if(k.includes("falha")) return "falha";
  if(k.includes("descart")) return "descartado";
  return "sucesso";
}

function fmtDuration(ms){
  const n=Number(ms);
  if(!Number.isFinite(n)||n<0) return "";
  if(n<1000) return `${n} ms`;
  const s=n/1000;
  if(s<60) return `${s.toFixed(1)} s`;
  const m=Math.floor(s/60), rem=(s%60).toFixed(0);
  return `${m}m ${rem}s`;
}

function fmtLogDate(isoStr){
  if(!isoStr) return "";
  return formatDateTime(isoStr,{
    day:"2-digit",month:"2-digit",year:"numeric",
    hour:"2-digit",minute:"2-digit",second:"2-digit",
    hour12:false
  });
}

function normEvent(ev){
  return {
    id:ev.id||`${ev.numero_plano||""}|${ev.status||""}|${ev.timestamp||""}|${ev.etapa||""}`,
    etapa:ev.etapa||"",
    numero_plano:ev.numero_plano||"",
    status:ev.status||"",
    usuario:ev.usuario||"",
    duracao_ms:ev.duracao_ms??null,
    timestamp:ev.timestamp||null
  };
}

function abrirModalConclusao(){
  if(!el.modalConcluido) return;
  el.modalConcluido.classList.add("active");
  el.modalConcluido.setAttribute("aria-hidden","false");
  if(el.btnModalOk){
    try{el.btnModalOk.focus();return;}catch(_e){}
  }
  const card=el.modalConcluido?el.modalConcluido.querySelector(".modal-window"):null;
  if(card){
    try{card.focus();}catch(_e){}
  }
}

function fecharModalConclusao(){
  if(!el.modalConcluido) return;
  el.modalConcluido.classList.remove("active");
  el.modalConcluido.setAttribute("aria-hidden","true");
}

function setBar(p){el.barTotal.style.width=`${p}%`;el.lblTotal.textContent=`${p}% concluído`}
function stateButtons(estado){
  const s=String(estado);
  el.btnIniciar.disabled=!(s==="ocioso"||s==="concluido");
  el.btnPausar.disabled=!(s==="executando");
  el.btnContinuar.disabled=!(s==="pausado");
  el.btnContinuar.classList.toggle("primary",s==="pausado");
  el.estadoTexto.textContent=s==="executando"?"Em processamento":s==="pausado"?"Pausado":"Ocioso";
}
async function api(path,opts={}){const r=await fetch(path,{headers:{"Content-Type":"application/json"},...opts});if(!r.ok)throw new Error(await r.text());return r.json()}

function updateFooter(hasData){
  el.footerInfo.textContent=hasData
    ? `exibindo ${tamanho} por pág. • ${totalPlanos.passiveis??0} planos passíveis de rescisão.`
    : "nada a exibir por aqui.";
  el.btnAnterior.disabled=(pagina<=1); el.btnProximo.disabled=(pagina>=maxPaginas);
  el.lblPaginaTotal.textContent=`pág. ${pagina} de ${maxPaginas}`;
}
function updateFooterOcc(hasData){
  el.footerInfoOcc.textContent=hasData
    ? `exibindo ${tamanho} por pág. • ${totalOcc} ocorrências.`
    : "nada a exibir por aqui.";
  el.btnAnteriorOcc.disabled=(paginaOcc<=1); el.btnProximoOcc.disabled=(paginaOcc>=maxPaginasOcc);
  el.lblPaginaTotalOcc.textContent=`pág. ${paginaOcc} de ${maxPaginasOcc}`;
}
function attachCopyHandlers(container){
  container.querySelectorAll(".copy").forEach(a=>{
    a.onclick=async (e)=>{
      e.preventDefault();
      const raw=a.getAttribute("data-copy")||a.textContent.trim();
      const text=a.dataset.copyType==="cnpj"?raw.replace(/\D+/g,""):raw;
      try{
        await navigator.clipboard.writeText(text);
        if(a._copyTimer){clearTimeout(a._copyTimer);a._copyTimer=null;}
        a.classList.remove("copied");
        const raf=(window.requestAnimationFrame?window.requestAnimationFrame.bind(window):(fn)=>setTimeout(fn,0));
        raf(()=>{
          a.classList.add("copied");
          a._copyTimer=setTimeout(()=>{a.classList.remove("copied");a._copyTimer=null;},900);
        });
      }catch{}
    };
  });
}

function renderLogs(){
  if(!el.tbodyLogs) return;
  el.tbodyLogs.innerHTML="";
  latestLogs
    .slice()
    .sort((a,b)=>(new Date(b.timestamp))-(new Date(a.timestamp)))
    .forEach(ev=>{
      const tr=document.createElement("tr");
      const badge=statusClass(ev.status);
      tr.innerHTML=`
        <td>${ev.etapa}</td>
        <td>${ev.numero_plano}</td>
        <td><span class="badge-status ${badge}">${ev.status}</span></td>
        <td>${ev.usuario||""}</td>
        <td>${fmtDuration(ev.duracao_ms)}</td>
        <td>${fmtLogDate(ev.timestamp)}</td>
      `;
      el.tbodyLogs.appendChild(tr);
    });
}

async function carregarLogsIniciais(){
  try{
    const data=await api("/logs?limit=10&order=desc");
    const items=Array.isArray(data.items)?data.items:[];
    latestLogs=items.map(normEvent).slice(0,MAX_LOGS);
    if(logsOpen) renderLogs();
  }catch(e){
    console.warn("Falha ao carregar /logs iniciais:",e);
  }
}

async function carregarPlanos(){
  const data=await api(`/captura/planos?pagina=${pagina}&tamanho=${tamanho}`);
  const items=data.items||[];
  const totalRegistros=data.total??items.length;
  totalPlanos={all:totalRegistros, passiveis:data.total_passiveis??0};
  maxPaginas=Math.max(1,Math.ceil(totalRegistros/tamanho));
  if(pagina>maxPaginas){pagina=maxPaginas;return carregarPlanos()}
  el.tbody.innerHTML="";
  items.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a class="copy" data-copy="${p.numero_plano}" href="#">${p.numero_plano||""}</a></td>
      <td>${p.gifug||""}</td>
      <td>${p.situacao_atual||""}</td>
      <td>${p.tipo||""}</td>
      <td class="right">${p.dias_em_atraso??""}</td>
      <td class="right">${fmtMoney(p.saldo)}</td>
      <td>${formatDateBR(p.dt_situacao_atual)}</td>`;
    el.tbody.appendChild(tr);
  });
  attachCopyHandlers(el.tbody);
  updateFooter(totalRegistros>0);
}

async function carregarOcorrencias(){
  const params=new URLSearchParams({pagina:String(paginaOcc),tamanho:String(tamanho)});
  if(filtroSituacaoOcc&&filtroSituacaoOcc!=="TODAS"){
    params.set("situacao",filtroSituacaoOcc);
  }
  const data=await api(`/captura/ocorrencias?${params.toString()}`);
  const items=data.items||[];
  const totalRegistros=data.total??items.length;
  totalOcc=totalRegistros;
  maxPaginasOcc=Math.max(1,Math.ceil(totalRegistros/tamanho));
  if(paginaOcc>maxPaginasOcc){paginaOcc=maxPaginasOcc;return carregarOcorrencias()}
  el.tbodyOcc.innerHTML="";
  items.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a class="copy" data-copy="${p.numero_plano}" href="#">${p.numero_plano}</a></td>
      <td>${p.situacao}</td>
      <td><a class="copy" data-copy="${p.cnpj}" data-copy-type="cnpj" href="#">${p.cnpj}</a></td>
      <td>${p.tipo||""}</td>
      <td class="right">${fmtMoney(p.saldo)}</td>
      <td>${formatDateBR(p.dt_situacao_atual)}</td>`;
    el.tbodyOcc.appendChild(tr);
  });
  attachCopyHandlers(el.tbodyOcc);
  updateFooterOcc(totalRegistros>0);
  atualizarFiltroOcorrMenu();
}

function atualizarFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  const options=el.filtroOcorrMenu.querySelectorAll(".filter-option");
  let activeLabel="";
  options.forEach(option=>{
    const value=option.getAttribute("data-value")||"";
    const isActive=value===filtroSituacaoOcc;
    option.classList.toggle("active",isActive);
    option.setAttribute("aria-checked",isActive?"true":"false");
    if(isActive){
      activeLabel=option.textContent.trim();
    }
  });
  const fallbackLabel=options.length>0?options[0].textContent.trim():"";
  const currentLabel=activeLabel||fallbackLabel;
  if(el.filtroOcorrToggle){
    const baseLabel="Filtrar ocorrências por situação";
    const suffix=currentLabel?` (atual: ${currentLabel})`:"";
    el.filtroOcorrToggle.setAttribute("title",baseLabel+suffix);
    el.filtroOcorrToggle.setAttribute("aria-label",baseLabel+suffix);
  }
  if(el.filtroOcorrTrigger){
    const triggerTitle=currentLabel?`Situação (atual: ${currentLabel})`:"Situação";
    el.filtroOcorrTrigger.setAttribute("title",triggerTitle);
    el.filtroOcorrTrigger.setAttribute("aria-label",triggerTitle);
  }
}

function posicionarFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu||!el.filtroOcorrTrigger) return;
  const triggerRect=el.filtroOcorrTrigger.getBoundingClientRect();
  const minWidth=160;
  const margin=12;
  const viewportWidth=window.innerWidth||document.documentElement.clientWidth||0;
  const width=Math.max(minWidth,triggerRect.width);
  let left=triggerRect.left;
  if(left+width+margin>viewportWidth){
    left=Math.max(margin,viewportWidth-width-margin);
  }
  el.filtroOcorrMenu.style.minWidth=`${Math.round(width)}px`;
  el.filtroOcorrMenu.style.left=`${Math.round(left)}px`;
  let top=triggerRect.bottom+6;
  el.filtroOcorrMenu.style.top=`${Math.round(top)}px`;
  const menuRect=el.filtroOcorrMenu.getBoundingClientRect();
  const viewportHeight=window.innerHeight||document.documentElement.clientHeight||0;
  if(menuRect.bottom>viewportHeight-margin){
    const adjustedTop=Math.max(margin,triggerRect.top-menuRect.height-6);
    el.filtroOcorrMenu.style.top=`${Math.round(adjustedTop)}px`;
  }
}

function abrirFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  if(!el.filtroOcorrMenu.classList.contains("open")){
    el.filtroOcorrMenu.classList.add("open");
    if(el.filtroOcorrToggle){
      el.filtroOcorrToggle.setAttribute("aria-expanded","true");
      el.filtroOcorrToggle.classList.add("open");
    }
    if(!filtroOcorrOutsideHandler){
      filtroOcorrOutsideHandler=(event)=>{
        const target=event.target;
        if(el.filtroOcorrMenu&&el.filtroOcorrMenu.contains(target)) return;
        if(el.filtroOcorrToggle&&el.filtroOcorrToggle.contains(target)) return;
        if(el.filtroOcorrTrigger&&el.filtroOcorrTrigger.contains(target)) return;
        fecharFiltroOcorrMenu();
      };
      document.addEventListener("mousedown",filtroOcorrOutsideHandler);
      document.addEventListener("touchstart",filtroOcorrOutsideHandler);
    }
    if(!filtroOcorrScrollHandler){
      filtroOcorrScrollHandler=()=>fecharFiltroOcorrMenu();
      window.addEventListener("scroll",filtroOcorrScrollHandler,true);
    }
    if(!filtroOcorrResizeHandler){
      filtroOcorrResizeHandler=()=>{
        if(el.filtroOcorrMenu&&el.filtroOcorrMenu.classList.contains("open")){
          posicionarFiltroOcorrMenu();
        }
      };
      window.addEventListener("resize",filtroOcorrResizeHandler);
    }
    if(!filtroOcorrKeydownHandler){
      filtroOcorrKeydownHandler=(event)=>{
        if(event.key==="Escape"){
          fecharFiltroOcorrMenu();
          if(el.filtroOcorrToggle){
            try{el.filtroOcorrToggle.focus({preventScroll:true});}catch(_e){}
          }
        }
      };
      document.addEventListener("keydown",filtroOcorrKeydownHandler);
    }
  }
  posicionarFiltroOcorrMenu();
  const activeOption=el.filtroOcorrMenu.querySelector(".filter-option.active");
  if(activeOption){
    try{activeOption.focus({preventScroll:true});}catch(_e){}
  }
}

function fecharFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  if(!el.filtroOcorrMenu.classList.contains("open")) return;
  el.filtroOcorrMenu.classList.remove("open");
  el.filtroOcorrMenu.style.removeProperty("left");
  el.filtroOcorrMenu.style.removeProperty("top");
  el.filtroOcorrMenu.style.removeProperty("minWidth");
  if(el.filtroOcorrToggle){
    el.filtroOcorrToggle.setAttribute("aria-expanded","false");
    el.filtroOcorrToggle.classList.remove("open");
  }
  if(filtroOcorrOutsideHandler){
    document.removeEventListener("mousedown",filtroOcorrOutsideHandler);
    document.removeEventListener("touchstart",filtroOcorrOutsideHandler);
    filtroOcorrOutsideHandler=null;
  }
  if(filtroOcorrScrollHandler){
    window.removeEventListener("scroll",filtroOcorrScrollHandler,true);
    filtroOcorrScrollHandler=null;
  }
  if(filtroOcorrResizeHandler){
    window.removeEventListener("resize",filtroOcorrResizeHandler);
    filtroOcorrResizeHandler=null;
  }
  if(filtroOcorrKeydownHandler){
    document.removeEventListener("keydown",filtroOcorrKeydownHandler);
    filtroOcorrKeydownHandler=null;
  }
}

function alternarFiltroOcorrMenu(){
  if(!el.filtroOcorrMenu) return;
  if(el.filtroOcorrMenu.classList.contains("open")){
    fecharFiltroOcorrMenu();
  }else{
    abrirFiltroOcorrMenu();
  }
}

async function carregarStatus(){
  const s=await api("/captura/status");
  const estadoAtual=s.estado;
  stateButtons(estadoAtual); setBar(s.progresso_total);
  const ultimaAtualizacao=formatDateTime(s.ultima_atualizacao);
  el.ultima.textContent="Última atualização: "+(ultimaAtualizacao||"—");
  el.badgeOcorr.textContent = s.ocorrencias_total ?? 0;
  if(ultimoEstado && ultimoEstado!=="concluido" && estadoAtual==="concluido"){
    abrirModalConclusao();
  }
  ultimoEstado=estadoAtual;

  try{
    const incoming=Array.isArray(s.historico)?s.historico:[];
    if(incoming.length){
      const map=new Map(latestLogs.map(ev=>[ev.id,ev]));
      incoming.map(normEvent).forEach(ev=>{map.set(ev.id,ev);});
      latestLogs=Array.from(map.values())
        .filter(ev=>ev.timestamp)
        .sort((a,b)=>(new Date(b.timestamp))-(new Date(a.timestamp)))
        .slice(0,MAX_LOGS);
      if(logsOpen) renderLogs();
    }
  }catch(_e){}
}

function startPolling(){
  if(timer) clearInterval(timer);
  timer=setInterval(async()=>{ try{
    await carregarStatus();
    if(document.getElementById("wrapPlanos").style.display!=="none") await carregarPlanos();
    else await carregarOcorrencias();
  }catch(e){console.error(e)} },2000);
}

el.btnIniciar.onclick=async()=>{await api("/captura/iniciar",{method:"POST"});await carregarStatus();startPolling()};
el.btnPausar.onclick=async()=>{await api("/captura/pausar",{method:"POST"});await carregarStatus()};
el.btnContinuar.onclick=async()=>{await api("/captura/continuar",{method:"POST"});await carregarStatus()};
el.btnProximo.onclick=()=>{if(pagina<maxPaginas){pagina+=1;carregarPlanos()}};
el.btnAnterior.onclick=()=>{if(pagina>1){pagina-=1;carregarPlanos()}};
el.btnProximoOcc.onclick=()=>{if(paginaOcc<maxPaginasOcc){paginaOcc+=1;carregarOcorrencias()}};
el.btnAnteriorOcc.onclick=()=>{if(paginaOcc>1){paginaOcc-=1;carregarOcorrencias()}};

function setLogsOpen(open){
  logsOpen=!!open;
  if(!el.logsBody||!el.logsHeader) return;
  if(logsOpen){
    el.logsBody.hidden=false;
    el.logsHeader.setAttribute("aria-expanded","true");
    if(!latestLogs.length) carregarLogsIniciais().then(()=>renderLogs());
    else renderLogs();
  }else{
    el.logsBody.hidden=true;
    el.logsHeader.setAttribute("aria-expanded","false");
  }
}

if(el.logsHeader){
  const toggle=(e)=>{e.preventDefault();setLogsOpen(!logsOpen);};
  el.logsHeader.addEventListener("click",toggle);
  el.logsHeader.addEventListener("keydown",(e)=>{if(e.key==="Enter"||e.key===" "){toggle(e);} });
}
setLogsOpen(false);

function downloadBlob(blob,filename){
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

function setTratamentoEstado(estado){
  if(!el.tratamentoEstado) return;
  const s=String(estado||"");
  let label="Ocioso";
  if(s==="processando") label="Em execução";
  else if(s==="aguardando") label="Aguardando fila";
  else if(s==="pausado") label="Pausado";
  el.tratamentoEstado.textContent=label;
  if(el.btnTratamentoIniciar){
    el.btnTratamentoIniciar.disabled=!(s==="ocioso"||s==="aguardando");
  }
  if(el.btnTratamentoPausar){
    el.btnTratamentoPausar.disabled=(s!=="processando");
  }
  if(el.btnTratamentoContinuar){
    const canContinue=(s==="pausado");
    el.btnTratamentoContinuar.disabled=!canContinue;
    el.btnTratamentoContinuar.classList.toggle("primary",canContinue);
  }
}

function formatTreatmentStatus(status){
  const map={
    pendente:"Pendente",
    processando:"Processando",
    rescindido:"Rescindido",
    descartado:"Descartado"
  };
  const key=String(status||"").toLowerCase();
  return map[key]||status||"";
}

function formatStageDisplayStatus(status){
  const map={
    pendente:"Pendente",
    processando:"Em andamento",
    concluido:"Concluída",
    cancelado:"Cancelada"
  };
  const key=String(status||"").toLowerCase();
  return map[key]||status||"";
}

function renderTratamentoResumo(plan){
  if(!el.tratamentoResumo||!el.btnDownloadNotepad) return;
  if(!plan){
    el.tratamentoResumo.textContent="Selecione ou aguarde um plano iniciar.";
    el.btnDownloadNotepad.disabled=true;
    el.btnDownloadNotepad.dataset.planId="";
    el.btnDownloadNotepad.dataset.numero="";
    return;
  }
  const rescisao = plan.rescisao_data ? formatDateBR(plan.rescisao_data) : "—";
  el.tratamentoResumo.innerHTML=`
    <div class="treatment-summary">
      <div><strong>Plano:</strong> ${plan.numero_plano}</div>
      <div><strong>Razão social:</strong> ${plan.razao_social}</div>
      <div><strong>CNPJs:</strong> ${Array.isArray(plan.cnpjs)?plan.cnpjs.join(", "):""}</div>
      <div><strong>Bases:</strong> ${Array.isArray(plan.bases)?plan.bases.join(", "):""}</div>
      <div><strong>Status:</strong> ${formatTreatmentStatus(plan.status)}</div>
      <div><strong>Data da rescisão:</strong> ${rescisao}</div>
    </div>`;
  el.btnDownloadNotepad.disabled=false;
  el.btnDownloadNotepad.dataset.planId=plan.id;
  el.btnDownloadNotepad.dataset.numero=plan.numero_plano;
}

function renderTratamentoEtapas(plan){
  if(!el.listaEtapas) return;
  el.listaEtapas.innerHTML="";
  if(!plan||!Array.isArray(plan.etapas)) return;
  plan.etapas.forEach(stage=>{
    const li=document.createElement("li");
    const status=(stage.status||"").toLowerCase();
    li.className=`stage ${status}`;
    const nome=stage.nome||TREATMENT_STAGE_NAMES[stage.id]||`Etapa ${stage.id}`;
    const inicio=stage.iniciado_em?formatDateTime(stage.iniciado_em,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—";
    const fim=stage.finalizado_em?formatDateTime(stage.finalizado_em,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—";
    li.innerHTML=`
      <div class="stage-header">
        <span>${stage.id}. ${nome}</span>
        <span class="stage-status-label">${formatStageDisplayStatus(status)}</span>
      </div>
      <div class="stage-info">${stage.mensagem||""}</div>
      <div class="stage-dates"><span>Início: ${inicio}</span><span>Término: ${fim}</span></div>
    `;
    el.listaEtapas.appendChild(li);
  });
}

function renderTratamentoFila(data){
  if(!el.tbodyTratamentoFila) return;
  el.tbodyTratamentoFila.innerHTML="";
  const planos=Array.isArray(data.planos)?data.planos:[];
  const fila=Array.isArray(data.fila)?data.fila:[];
  if(el.tratamentoEmpty) el.tratamentoEmpty.hidden=!!planos.length;
  planos.forEach(plan=>{
    const tr=document.createElement("tr");
    tr.classList.add("queue-row");
    if(plan.id===data.atual) tr.classList.add("current");
    if(plan.status==="rescindido") tr.classList.add("rescindido");
    if(plan.status==="descartado") tr.classList.add("descartado");
    const pos=fila.indexOf(plan.id);
    let badge="";
    if(plan.id===data.atual) badge="Em execução";
    else if(plan.status==="pendente"&&pos>=0) badge=`Na fila #${pos+1}`;
    else if(plan.status==="rescindido") badge="Rescindido";
    else if(plan.status==="descartado") badge="Descartado";
    const badgeHtml=badge?`<span class="queue-badge">${badge}</span>`:"";
    const etapaAtual=plan.etapa_atual?`${plan.etapa_atual} / 7`:"—";
    const btn=`<button class="btn-link" data-action="download-notepad" data-plan-id="${plan.id}" data-numero="${plan.numero_plano}">Bloco (.txt)</button>`;
    tr.innerHTML=`
      <td>${plan.numero_plano}</td>
      <td>${plan.razao_social}</td>
      <td>${formatTreatmentStatus(plan.status)} ${badgeHtml}</td>
      <td>${etapaAtual}</td>
      <td>${btn}</td>
    `;
    el.tbodyTratamentoFila.appendChild(tr);
  });
}

function formatLogStatus(status){
  if(!status) return "";
  const map={SUCESSO:"Sucesso",INICIO:"Início",DESCARTADO:"Descartado"};
  const upper=String(status).toUpperCase();
  if(map[upper]) return map[upper];
  return upper.charAt(0)+upper.slice(1).toLowerCase();
}

function renderTratamentoLogs(logs,planos){
  if(!el.tbodyTratamentoLogs) return;
  el.tbodyTratamentoLogs.innerHTML="";
  const map=new Map((Array.isArray(planos)?planos:[]).map(p=>[p.id,p]));
  (Array.isArray(logs)?logs:[])
    .slice()
    .sort((a,b)=>{
      const da=a.created_at?new Date(a.created_at).getTime():0;
      const db=b.created_at?new Date(b.created_at).getTime():0;
      return db-da;
    })
    .forEach(log=>{
      const tr=document.createElement("tr");
      const plan=map.get(log.treatment_id);
      const etapaNome=TREATMENT_STAGE_NAMES[log.etapa]||`Etapa ${log.etapa}`;
      const quando=log.created_at?formatDateTime(log.created_at,{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"";
      tr.innerHTML=`
        <td>${quando}</td>
        <td>${plan?plan.numero_plano:"—"}</td>
        <td>${etapaNome}</td>
        <td>${formatLogStatus(log.status)}</td>
        <td>${log.mensagem||""}</td>
      `;
      el.tbodyTratamentoLogs.appendChild(tr);
    });
}

function atualizarTratamentoUI(data){
  tratamentoDados=data;
  setTratamentoEstado(data.estado);
  const planos=Array.isArray(data.planos)?data.planos:[];
  const atualId=data.atual;
  const planoAtual=planos.find(p=>p.id===atualId)||planos.find(p=>p.status==="processando")||null;
  renderTratamentoResumo(planoAtual);
  renderTratamentoEtapas(planoAtual);
  renderTratamentoFila(data);
  renderTratamentoLogs(data.logs||[],planos);
}

async function carregarTratamentoStatus(){
  if(tratamentoLoading) return;
  tratamentoLoading=true;
  try{
    const data=await api("/tratamentos/status");
    atualizarTratamentoUI(data);
  }catch(e){
    console.error("Falha ao carregar tratamentos",e);
  }finally{
    tratamentoLoading=false;
  }
}

function startTratamentoPolling(){
  stopTratamentoPolling();
  tratamentoTimer=setInterval(()=>{carregarTratamentoStatus();},4000);
}

function stopTratamentoPolling(){
  if(tratamentoTimer){
    clearInterval(tratamentoTimer);
    tratamentoTimer=null;
  }
}

function ativarTratamentoTab(){
  carregarTratamentoStatus();
  startTratamentoPolling();
}

function desativarTratamentoTab(){
  stopTratamentoPolling();
}

async function migrarPlanos(){
  if(!el.btnTratamentoSeed) return;
  el.btnTratamentoSeed.disabled=true;
  try{
    await api("/tratamentos/migrar",{method:"POST"});
    await carregarTratamentoStatus();
  }catch(e){
    console.error(e);
    alert("Não foi possível migrar os planos para tratamento.");
  }finally{
    el.btnTratamentoSeed.disabled=false;
  }
}

async function iniciarTratamento(){
  if(!el.btnTratamentoIniciar) return;
  el.btnTratamentoIniciar.disabled=true;
  try{
    await api("/tratamentos/iniciar",{method:"POST"});
    await carregarTratamentoStatus();
  }catch(e){
    console.error(e);
    alert("Não foi possível iniciar a fila de tratamento.");
  }finally{
    el.btnTratamentoIniciar.disabled=false;
  }
}

async function pausarTratamento(){
  if(!el.btnTratamentoPausar) return;
  el.btnTratamentoPausar.disabled=true;
  try{
    await api("/tratamentos/pausar",{method:"POST"});
    await carregarTratamentoStatus();
  }catch(e){
    console.error(e);
    alert("Não foi possível pausar a fila de tratamento.");
  }finally{
    el.btnTratamentoPausar.disabled=false;
  }
}

async function continuarTratamento(){
  if(!el.btnTratamentoContinuar) return;
  el.btnTratamentoContinuar.disabled=true;
  try{
    await api("/tratamentos/continuar",{method:"POST"});
    await carregarTratamentoStatus();
  }catch(e){
    console.error(e);
    alert("Não foi possível continuar a fila de tratamento.");
  }finally{
    el.btnTratamentoContinuar.disabled=false;
  }
}

async function downloadTratamentoNotepad(id,numero){
  if(!id) return;
  try{
    const res=await fetch(`/tratamentos/${id}/notepad`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob=await res.blob();
    const filename=numero?`bloco_plano_${numero}.txt`:`bloco_plano_${id}.txt`;
    downloadBlob(blob,filename);
  }catch(e){
    console.error(e);
    alert("Não foi possível baixar o bloco de notas do plano.");
  }
}

async function downloadRescindidos(){
  if(!el.inputRescindidosData||!el.btnDownloadRescindidos) return;
  const value=el.inputRescindidosData.value;
  if(!value){
    alert("Informe a data para gerar o arquivo de rescindidos.");
    return;
  }
  el.btnDownloadRescindidos.disabled=true;
  try{
    const res=await fetch(`/tratamentos/rescindidos-txt?data=${value}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob=await res.blob();
    downloadBlob(blob,"Rescindidos_CNPJ.txt");
  }catch(e){
    console.error(e);
    alert("Não foi possível gerar o arquivo Rescindidos_CNPJ.txt.");
  }finally{
    el.btnDownloadRescindidos.disabled=false;
  }
}

function setActiveTab(name){
  if(!name) return;
  if(name===activeTab) return;
  activeTab=name;
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.classList.toggle("active",tab.dataset.tab===name);
  });
  document.querySelectorAll(".content > section").forEach(section=>{
    section.style.display=section.id===`tab-${name}`?"block":"none";
  });
  if(name==="tratamento") ativarTratamentoTab();
  else desativarTratamentoTab();
}

function toISODate(val){
  return /^\d{4}-\d{2}-\d{2}$/.test(val)?val:"";
}

function toBRFileDate(val){
  const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(val||"");
  return m?`${m[3]}${m[2]}${m[1]}`:"";
}

async function exportLogsXlsx(){
  if(!el.logsFrom||!el.logsTo||!el.btnExportLogs) return;
  const fromISO=toISODate(el.logsFrom.value);
  const toISO=toISODate(el.logsTo.value);
  if(!fromISO||!toISO){
    alert("Selecione as datas inicial e final.");
    return;
  }
  const fromBR=toBRFileDate(fromISO);
  const toBR=toBRFileDate(toISO);
  const filename=`logs_sirep_intervalo_${fromBR}-${toBR}.xlsx`;

  el.btnExportLogs.disabled=true;
  try{
    const res=await fetch(`/logs/export?from=${fromISO}&to=${toISO}`,{method:"GET"});
    if(!res.ok) throw new Error(`Export falhou: ${res.status}`);
    const blob=await res.blob();
    downloadBlob(blob,filename);
  }catch(e){
    console.error(e);
    alert("Não foi possível exportar os logs. Tente novamente.");
  }finally{
    el.btnExportLogs.disabled=false;
  }
}

if(el.btnExportLogs){
  el.btnExportLogs.addEventListener("click",(e)=>{e.preventDefault();exportLogsXlsx();});
}

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",event=>{
    event.preventDefault();
    const target=tab.dataset.tab;
    if(target) setActiveTab(target);
  });
});

if(el.btnTratamentoSeed){
  el.btnTratamentoSeed.addEventListener("click",event=>{
    event.preventDefault();
    migrarPlanos();
  });
}

if(el.btnTratamentoIniciar){
  el.btnTratamentoIniciar.addEventListener("click",event=>{
    event.preventDefault();
    iniciarTratamento();
  });
}
if(el.btnTratamentoPausar){
  el.btnTratamentoPausar.addEventListener("click",event=>{
    event.preventDefault();
    pausarTratamento();
  });
}
if(el.btnTratamentoContinuar){
  el.btnTratamentoContinuar.addEventListener("click",event=>{
    event.preventDefault();
    continuarTratamento();
  });
}

if(el.btnDownloadNotepad){
  el.btnDownloadNotepad.addEventListener("click",event=>{
    event.preventDefault();
    const id=Number(el.btnDownloadNotepad.dataset.planId||"0");
    const numero=el.btnDownloadNotepad.dataset.numero||"";
    if(id) downloadTratamentoNotepad(id,numero);
  });
}

if(el.btnDownloadRescindidos){
  el.btnDownloadRescindidos.addEventListener("click",event=>{
    event.preventDefault();
    downloadRescindidos();
  });
}

document.addEventListener("click",event=>{
  const target=event.target.closest('[data-action="download-notepad"]');
  if(!target) return;
  event.preventDefault();
  const id=Number(target.getAttribute("data-plan-id")||"0");
  const numero=target.getAttribute("data-numero")||"";
  if(id) downloadTratamentoNotepad(id,numero);
});

el.subtabPlanos.onclick=()=>{fecharFiltroOcorrMenu();el.subtabPlanos.classList.add("active");el.subtabOcorr.classList.remove("active");$("#wrapPlanos").style.display="block";$("#wrapOcorr").style.display="none";};
el.subtabOcorr.onclick=()=>{fecharFiltroOcorrMenu();el.subtabOcorr.classList.add("active");el.subtabPlanos.classList.remove("active");$("#wrapPlanos").style.display="none";$("#wrapOcorr").style.display="block";carregarOcorrencias();};

if(el.filtroOcorrToggle){
  el.filtroOcorrToggle.addEventListener("click",event=>{
    event.preventDefault();
    event.stopPropagation();
    alternarFiltroOcorrMenu();
  });
}
if(el.filtroOcorrTrigger){
  el.filtroOcorrTrigger.addEventListener("click",event=>{
    if(event.target&&event.target.closest(".filter-toggle")) return;
    event.preventDefault();
    alternarFiltroOcorrMenu();
  });
}
if(el.filtroOcorrMenu){
  el.filtroOcorrMenu.querySelectorAll(".filter-option").forEach(option=>{
    option.addEventListener("click",event=>{
      event.preventDefault();
      event.stopPropagation();
      const value=option.getAttribute("data-value")||"";
      if(!value) return;
      if(value!==filtroSituacaoOcc){
        filtroSituacaoOcc=value;
        paginaOcc=1;
        atualizarFiltroOcorrMenu();
        carregarOcorrencias();
      }
      fecharFiltroOcorrMenu();
    });
  });
}

atualizarFiltroOcorrMenu();

if(el.btnModalOk){
  el.btnModalOk.addEventListener("click",()=>{
    fecharModalConclusao();
  });
}

if(el.btnModalClose){
  el.btnModalClose.addEventListener("click",()=>{
    fecharModalConclusao();
  });
}

document.addEventListener("keydown",event=>{
  if(event.key==="Escape"&&el.modalConcluido&&el.modalConcluido.classList.contains("active")){
    fecharModalConclusao();
  }
});

document.addEventListener("DOMContentLoaded", async()=>{
  if(el.inputRescindidosData){
    try{el.inputRescindidosData.value=new Date().toISOString().slice(0,10);}catch(_e){}
  }
  setActiveTab("gestao");
  await carregarStatus();
  await carregarPlanos();
  startPolling();
  carregarLogsIniciais();
});
</script>
</body>
</html>
