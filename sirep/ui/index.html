<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>SIREP 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--accent:#0039BA;--text:#111;--muted:#6b7280;--line:#e5e7eb;--bg:#fff;--hdr-a:#0B5FA8;--hdr-b:#108CBC;--hdr-c:#49C3B6;--prog-a:#ef7d00;--prog-b:#F7A600}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--hdr-a),var(--hdr-b),var(--hdr-c));color:#fff}
    .top{display:flex;align-items:center;justify-content:center;padding:12px 16px;position:relative}
    .top h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.5px}
    .top .icons{position:absolute;right:12px;display:flex;gap:12px}
    .icon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,.12);cursor:pointer}
    main{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tab{padding:12px 16px;cursor:pointer;font-weight:600;border-bottom:2px solid transparent}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .content{padding:16px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:1px solid var(--line);background:#fff;color:#111;padding:9px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    button.primary{border-color:var(--accent);color:#fff;background:var(--accent)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .progress{height:10px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;overflow:hidden;min-width:180px;flex:0 0 240px}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--prog-a),var(--prog-b));position:relative;transition:width .2s ease}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--line)}
    th{text-align:left;font-size:12px;color:#4b5563} .right{text-align:right}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px} @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .log{border:1px solid var(--line);border-radius:10px;padding:10px;height:320px;overflow:auto;background:#fafafa}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .state{font-weight:700}
    /* sub-abas dentro da seção */
    .subtabs{display:flex;gap:14px;align-items:center;margin:12px 0 6px}
    .subtab{font-weight:700;opacity:.6;cursor:pointer}
    .subtab.active{color:var(--accent);opacity:1}
    .badge{display:inline-block;min-width:18px;padding:0 6px;border-radius:999px;background:#fef2f2;color:#b91c1c;font-weight:800;font-size:11px;border:1px solid #fecaca;vertical-align:middle;margin-left:6px}
    /* link copyable */
    .copy{color:#0b5fa8;cursor:pointer;text-decoration:underline;position:relative;display:inline-block}
    .copy.copied{color:#16a34a;text-decoration:none}
    .copy.copied::after{content:"item copiado";position:absolute;left:50%;top:-32px;transform:translateX(-50%);background:rgba(17,17,17,.92);color:#fff;font-size:11px;font-weight:600;padding:4px 8px;border-radius:6px;white-space:nowrap;box-shadow:0 4px 10px rgba(0,0,0,.18);pointer-events:none;animation:copy-tooltip .9s ease;z-index:20}
    .copy.copied::before{content:"";position:absolute;left:50%;top:-10px;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(17,17,17,.92);pointer-events:none;animation:copy-tooltip-arrow .9s ease;z-index:19}
    @keyframes copy-tooltip{0%{opacity:0;transform:translate(-50%,-4px)}20%{opacity:1;transform:translate(-50%,-10px)}80%{opacity:1;transform:translate(-50%,-12px)}100%{opacity:0;transform:translate(-50%,-14px)}}
    @keyframes copy-tooltip-arrow{0%{opacity:0;transform:translate(-50%,2px)}20%{opacity:1;transform:translate(-50%,0)}80%{opacity:1;transform:translate(-50%,-1px)}100%{opacity:0;transform:translate(-50%,-2px)}}
  </style>
</head>
<body>
<header>
  <div class="top">
    <h1>SIREP 2.0</h1>
    <div class="icons">
      <div class="icon" title="Configurações" aria-label="Configurações">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V22a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.04 2.4l.06.06a1.65 1.65 0 0 0 1.82.33H8a1.65 1.65 0 0 0 1-1.51V2a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V8c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73H22a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </div>
      <div class="icon" title="Conta" aria-label="Conta">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="gestao">Gestão da Base</div>
      <div class="tab" data-tab="tratamento">Tratamento</div>
    </div>
    <div class="content">
      <section id="tab-gestao">
        <div class="grid">
          <div>
            <div class="row" style="margin-bottom:10px;">
              <div class="controls">
                <button id="btnIniciar" class="primary">Iniciar</button>
                <button id="btnPausar">Pausar</button>
                <button id="btnContinuar" disabled>Continuar</button>
              </div>
              <div class="row">
                <div class="progress" title="Progresso total"><div id="barTotal" style="width:0%"></div></div>
                <span id="lblTotal" class="muted">0% concluído</span>
              </div>
            </div>

            <div class="muted" id="ultimaAtualizacao">Última atualização: —</div>

            <div class="subtabs">
              <span class="subtab active" id="subtabPlanos">Planos capturados</span>
              <span class="subtab" id="subtabOcorr">Ocorrências <span class="badge" id="badgeOcorr">0</span></span>
            </div>

            <!-- Tabela Planos -->
            <div id="wrapPlanos">
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th>CARTEIRA</th><th>GIFUG</th><th>SITUAÇÃO</th><th>TIPO</th>
                    <th class="right">DIAS EM ATRASO</th><th class="right">SALDO</th><th>DT SITUAÇÃO</th>
                  </tr></thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
              <div class="footer">
                <div class="muted" id="footerInfo">exibindo 10 por página • 0 planos passíveis de rescisão.</div>
                <div><button id="btnAnterior">Anterior</button><span class="muted" id="lblPaginaTotal" style="margin:0 6px">página 1 de 1</span><button id="btnProximo">Próximo</button></div>
              </div>
            </div>

            <!-- Tabela Ocorrências -->
            <div id="wrapOcorr" style="display:none">
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th>CARTEIRA</th><th>SITUAÇÃO</th><th>CNPJ</th><th>TIPO</th><th class="right">SALDO</th><th>DT SITUAÇÃO</th>
                  </tr></thead>
                  <tbody id="tbodyOcc"></tbody>
                </table>
              </div>
              <div class="footer">
                <div class="muted" id="footerInfoOcc">exibindo 10 por página • 0 ocorrências.</div>
                <div><button id="btnAnteriorOcc">Anterior</button><span class="muted" id="lblPaginaTotalOcc" style="margin:0 6px">página 1 de 1</span><button id="btnProximoOcc">Próximo</button></div>
              </div>
            </div>
          </div>

          <aside>
            <h4 style="margin:6px 0 8px">Status: <span class="state" id="estadoTexto">Ocioso</span></h4>
            <div class="log" id="log"></div>
          </aside>
        </div>
      </section>

      <section id="tab-tratamento" style="display:none"><p class="muted">Em breve.</p></section>
    </div>
  </div>
</main>

<script>
function $(selector){ return document.querySelector(selector); }
const fmtMoney=n=>n==null?"":Number(n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const el={
  btnIniciar:$("#btnIniciar"), btnPausar:$("#btnPausar"), btnContinuar:$("#btnContinuar"),
  barTotal:$("#barTotal"), lblTotal:$("#lblTotal"), ultima:$("#ultimaAtualizacao"),
  tbody:$("#tbody"), btnProximo:$("#btnProximo"), btnAnterior:$("#btnAnterior"),
  lblPaginaTotal:$("#lblPaginaTotal"), footerInfo:$("#footerInfo"),
  tbodyOcc:$("#tbodyOcc"), btnProximoOcc:$("#btnProximoOcc"), btnAnteriorOcc:$("#btnAnteriorOcc"),
  lblPaginaTotalOcc:$("#lblPaginaTotalOcc"), footerInfoOcc:$("#footerInfoOcc"),
  log:$("#log"), estadoTexto:$("#estadoTexto"),
  subtabPlanos:$("#subtabPlanos"), subtabOcorr:$("#subtabOcorr"), badgeOcorr:$("#badgeOcorr")
};
let pagina=1,tamanho=10,totalPlanos=0,maxPaginas=1;
let paginaOcc=1,totalOcc=0,maxPaginasOcc=1;
let timer=null;

function setBar(p){el.barTotal.style.width=`${p}%`;el.lblTotal.textContent=`${p}% concluído`}
function stateButtons(estado){
  const s=String(estado);
  el.btnIniciar.disabled=!(s==="ocioso"||s==="concluido");
  el.btnPausar.disabled=!(s==="executando");
  el.btnContinuar.disabled=!(s==="pausado");
  el.btnContinuar.classList.toggle("primary",s==="pausado");
  el.estadoTexto.textContent=s==="executando"?"Em processamento":s==="pausado"?"Pausado":"Ocioso";
}
async function api(path,opts={}){const r=await fetch(path,{headers:{"Content-Type":"application/json"},...opts});if(!r.ok)throw new Error(await r.text());return r.json()}

function updateFooter(){
  el.footerInfo.textContent=`exibindo ${tamanho} por página • ${totalPlanos.passiveis??0} planos passíveis de rescisão.`;
  el.btnAnterior.disabled=(pagina<=1); el.btnProximo.disabled=(pagina>=maxPaginas);
  el.lblPaginaTotal.textContent=`página ${pagina} de ${maxPaginas}`;
}
function updateFooterOcc(){
  el.footerInfoOcc.textContent=`exibindo ${tamanho} por página • ${totalOcc} ocorrências.`;
  el.btnAnteriorOcc.disabled=(paginaOcc<=1); el.btnProximoOcc.disabled=(paginaOcc>=maxPaginasOcc);
  el.lblPaginaTotalOcc.textContent=`página ${paginaOcc} de ${maxPaginasOcc}`;
}
function attachCopyHandlers(container){
  container.querySelectorAll(".copy").forEach(a=>{
    a.onclick=async (e)=>{
      e.preventDefault();
      const raw=a.getAttribute("data-copy")||a.textContent.trim();
      const text=a.dataset.copyType==="cnpj"?raw.replace(/\D+/g,""):raw;
      try{
        await navigator.clipboard.writeText(text);
        if(a._copyTimer){clearTimeout(a._copyTimer);a._copyTimer=null;}
        a.classList.remove("copied");
        const raf=(window.requestAnimationFrame?window.requestAnimationFrame.bind(window):(fn)=>setTimeout(fn,0));
        raf(()=>{
          a.classList.add("copied");
          a._copyTimer=setTimeout(()=>{a.classList.remove("copied");a._copyTimer=null;},900);
        });
      }catch{}
    };
  });
}

async function carregarPlanos(){
  const data=await api(`/captura/planos?pagina=${pagina}&tamanho=${tamanho}`);
  const items=data.items||[]; totalPlanos={all:data.total??items.length, passiveis:data.total_passiveis??0};
  maxPaginas=Math.max(1,Math.ceil((data.total||items.length)/tamanho));
  if(pagina>maxPaginas){pagina=maxPaginas;return carregarPlanos()}
  el.tbody.innerHTML="";
  items.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a class="copy" data-copy="${p.numero_plano}" href="#">${p.numero_plano||""}</a></td>
      <td>${p.gifug||""}</td>
      <td>${p.situacao_atual||""}</td>
      <td>${p.tipo||""}</td>
      <td class="right">${p.dias_em_atraso??""}</td>
      <td class="right">${fmtMoney(p.saldo)}</td>
      <td>${p.dt_situacao_atual||""}</td>`;
    el.tbody.appendChild(tr);
  });
  attachCopyHandlers(el.tbody);
  updateFooter();
}

async function carregarOcorrencias(){
  const data=await api(`/captura/ocorrencias?pagina=${paginaOcc}&tamanho=${tamanho}`);
  const items=data.items||[]; totalOcc=data.total||0;
  maxPaginasOcc=Math.max(1,Math.ceil(totalOcc/tamanho));
  if(paginaOcc>maxPaginasOcc){paginaOcc=maxPaginasOcc;return carregarOcorrencias()}
  el.tbodyOcc.innerHTML="";
  items.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a class="copy" data-copy="${p.numero_plano}" href="#">${p.numero_plano}</a></td>
      <td>${p.situacao}</td>
      <td><a class="copy" data-copy="${p.cnpj}" data-copy-type="cnpj" href="#">${p.cnpj}</a></td>
      <td>${p.tipo||""}</td>
      <td class="right">${fmtMoney(p.saldo)}</td>
      <td>${p.dt_situacao_atual||""}</td>`;
    el.tbodyOcc.appendChild(tr);
  });
  attachCopyHandlers(el.tbodyOcc);
  updateFooterOcc();
}

function renderEmProgresso(list){
  el.log.innerHTML=""; list.forEach(item=>{
    const p=Math.min(4,Math.max(0,item.progresso));
    const pct=Math.round((p/4)*100);
    const div=document.createElement("p"); div.textContent=`${item.numero_plano} — ${pct}% (${item.etapas[p-1]||"Início"})`;
    el.log.appendChild(div);
  }); el.log.scrollTop=el.log.scrollHeight;
}

async function carregarStatus(){
  const s=await api("/captura/status");
  stateButtons(s.estado); setBar(s.progresso_total);
  renderEmProgresso(s.em_progresso||[]);
  el.ultima.textContent="Última atualização: "+(s.ultima_atualizacao?new Date(s.ultima_atualizacao).toLocaleString("pt-BR"):"—");
  el.badgeOcorr.textContent = s.ocorrencias_total ?? 0;
}

function startPolling(){
  if(timer) clearInterval(timer);
  timer=setInterval(async()=>{ try{
    await carregarStatus();
    if(document.getElementById("wrapPlanos").style.display!=="none") await carregarPlanos();
    else await carregarOcorrencias();
  }catch(e){console.error(e)} },2000);
}

el.btnIniciar.onclick=async()=>{await api("/captura/iniciar",{method:"POST"});await carregarStatus();startPolling()};
el.btnPausar.onclick=async()=>{await api("/captura/pausar",{method:"POST"});await carregarStatus()};
el.btnContinuar.onclick=async()=>{await api("/captura/continuar",{method:"POST"});await carregarStatus()};
el.btnProximo.onclick=()=>{if(pagina<maxPaginas){pagina+=1;carregarPlanos()}};
el.btnAnterior.onclick=()=>{if(pagina>1){pagina-=1;carregarPlanos()}};
el.btnProximoOcc.onclick=()=>{if(paginaOcc<maxPaginasOcc){paginaOcc+=1;carregarOcorrencias()}};
el.btnAnteriorOcc.onclick=()=>{if(paginaOcc>1){paginaOcc-=1;carregarOcorrencias()}};

el.subtabPlanos.onclick=()=>{el.subtabPlanos.classList.add("active");el.subtabOcorr.classList.remove("active");$("#wrapPlanos").style.display="block";$("#wrapOcorr").style.display="none";};
el.subtabOcorr.onclick=()=>{el.subtabOcorr.classList.add("active");el.subtabPlanos.classList.remove("active");$("#wrapPlanos").style.display="none";$("#wrapOcorr").style.display="block";carregarOcorrencias();};

document.addEventListener("DOMContentLoaded", async()=>{await carregarStatus();await carregarPlanos();startPolling();});
</script>
</body>
</html>